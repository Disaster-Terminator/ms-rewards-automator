# 登录系统开发总结

## 当前状态（2026-02-13 15:30）

**核心成果**：

- ✅ 2FA 自动提交 100% 成功（贝塞尔曲线 + 变速打字）
- ✅ 人类行为模拟系统完整实现
- ✅ 状态机架构完善（20 个状态，自动重试）
- ✅ 状态检测超时问题已修复（增加页面加载等待）
- 🔧 2FA 后状态识别待验证

**待解决**：

1. 移动浏览器 Windows 凭据弹窗（系统级，需改用 User-Agent 切换）
2. 2FA 后页面状态识别（已添加诊断，待测试）

---

## 核心问题排查

### 问题 1：2FA 提交按钮识别失败 ✅ 已解决

**根因**：微软更新 Fluent UI，旧选择器失效

```html
<!-- 新版 -->
<button type="submit" data-testid="primaryButton">Verify</button>
```

**解决**：添加 Fluent UI 选择器

```python
'button[type="submit"][data-testid="primaryButton"]'
```

---

### 问题 2：EdgePopupHandler 误点"保持登录"按钮 ✅ 已解决

**根因**：

- 选择器 `button[id*="close"]` 太宽泛
- 匹配到"Stay signed in?"页面的 `<button id="close-button">`
- 点击 = 点 No = 不保存登录

**解决**：

1. 移除状态机中 EdgePopupHandler 调用（chromium 无 Edge 弹窗）
2. 创建 `StaySignedInHandler` 专门处理
3. 添加 `STAY_SIGNED_IN` 状态

---

### 问题 3：状态检测超时 ✅ 已修复

**现象**：

```
2026-02-13 15:10:02 - Operation timeout: Detect state (from email_input)
```

**根因**：

- 页面导航后立即检测状态
- 只等待 `networkidle`，但 JavaScript 可能还在执行
- DOM 元素尚未渲染完成，所有选择器失效
- 30 秒超时触发

**解决**：

1. 状态检测前增加三重等待：
   - `domcontentloaded` - 确保 DOM 解析完成
   - `body` 元素存在 - 确保基础结构就绪
   - `networkidle` - 确保网络请求完成
2. 增加检测超时：30s → 60s
3. `wait_for_navigation` 优化：分阶段等待 + 额外 1 秒缓冲
4. 添加诊断系统保存截图和 HTML

---

### 问题 4：2FA 后状态识别失败 🔧 待测试

**现象**（测试 2）：

- 15:05:28 - 2FA 提交成功
- 15:05:29 - 登录超时（只过了 1 秒）
- 15:05:40 - 手动登录检测到 OAuth 回调页面

**分析**：

- 2FA 后进入未知状态
- 可能是"保持登录"页面或 OAuth 回调
- StaySignedInHandler 未生效

**修复**：

- ✅ 2FA 提交后保存页面 HTML/截图
- ✅ 增加状态检测超时
- 待测试验证

---

## 技术实现

### 1. 人类行为模拟

**贝塞尔曲线鼠标**：

- 三次曲线，随机控制点
- ease-in-out 速度
- 随机抖动

**变速打字**：

- 80-200ms/字符
- 15% 概率停顿 300-800ms
- 使用 `keyboard.type()`

### 2. 状态机架构

```python
while not logged_in:
    state = detect_state(page)  # 并行检测
    handle_state(state)         # 动态响应
    if same_state >= 4:         # 防卡死
        page.reload()
```

**关键状态**：

- EMAIL_INPUT, PASSWORD_INPUT
- TOTP_2FA, OTP_CODE_ENTRY
- STAY_SIGNED_IN, AUTH_BLOCKED
- LOGGED_IN, ERROR

### 3. 2FA 处理

**Fluent UI 选择器**：

```python
# 输入框
'input[id^="floatingLabelInput"]'
'input.fui-Input__input[type="text"]'

# 提交按钮
'button[type="submit"][data-testid="primaryButton"]'
```

**流程**：

1. 生成 TOTP：`pyotp.TOTP(secret).now()`
2. 变速输入验证码
3. 贝塞尔曲线点击提交
4. 保存页面 HTML（诊断用）

---

## 待解决问题

### 1. 移动浏览器凭据弹窗 ⚠️ 高优先级

**问题**：切换移动浏览器时 Windows 弹系统级凭据保存提示

**临时方案**：

```python
'--password-store=basic'  # 可能无效
```

**长期方案**（参考 TS 项目）：

- 不关闭浏览器，切换 User-Agent
- 避免触发 Windows 凭据管理器

### 2. 2FA 后状态识别 🔧 测试中

**已修复**：

- 增加检测超时 60s
- 等待 networkidle
- 保存诊断信息

**待验证**：

- StaySignedInHandler 是否生效
- OAuth 回调页面识别

---

## 测试记录

### 测试 1（14:45）

- ✅ 2FA 提交成功
- ❌ EdgePopupHandler 误点 No
- 结果：ERROR（已修复）

### 测试 2（15:00）

- ✅ AUTH_BLOCKED 自动重试
- ✅ 2FA 提交成功
- ❌ 超时（300s）
- ✅ 手动登录成功（OAuth 回调）

### 测试 3（15:09）

- ❌ 状态检测超时（30s）
- 原因：页面未加载完成
- 已修复：60s + networkidle

---

## 核心文件

- `src/login/human_behavior_simulator.py` - 人类行为
- `src/login/login_state_machine.py` - 状态机
- `src/login/handlers/totp_2fa_handler.py` - 2FA
- `src/login/handlers/stay_signed_in_handler.py` - 保持登录
- `src/browser/simulator.py` - 浏览器参数（凭据禁用）

---

## 下一步

1. 测试状态检测超时修复
2. 验证 2FA 后状态识别
3. 解决移动浏览器凭据弹窗（User-Agent 切换）
4. 优化：并行状态检测（参考 TS 项目）
5. 修复积分检测功能
6. 完善任务系统模块
7. 增加登录失败重试机制
8. 实现更智能的登录状态检测
