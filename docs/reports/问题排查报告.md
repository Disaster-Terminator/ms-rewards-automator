# 问题排查报告

**更新日期**: 2026-02-14  
**排查范围**: 任务模块、搜索计数、状态显示、积分检测

---

## 已修复问题

### 1. 搜索计数为 0 的问题

**问题**: 报告显示桌面搜索和移动搜索都是 0 次，但实际搜索已成功执行  
**原因**: `state_monitor.check_points_after_searches` 在监控禁用时直接返回，不更新搜索计数  
**修复**: 将搜索计数更新移到监控检查之前

**文件**: `src/infrastructure/state_monitor.py#L118-L127`

---

### 2. 状态显示 NoneType 比较错误

**问题**: `'>' not supported between instances of 'NoneType' and 'int'`  
**原因**: `current_points` 可能为 `None`，直接与 `0` 比较导致错误  
**修复**: 添加 `None` 检查

**文件**: `src/ui/real_time_status.py#L133-L135`

---

### 3. 积分检测错误（提取礼品卡面值）

**问题**: 积分检测返回 150,000，实际积分是 915  
**原因**: 正则表达式 `(\d[\d,]*)\s*(?:points|Points)` 匹配了页面上所有带 "points" 的数字，包括礼品卡面值（1000, 5000, 20000 等）

**修复**:

1. 优先使用选择器定位用户积分区域
2. 使用更精确的正则模式匹配用户积分
3. 避免匹配礼品卡目录中的积分值

**文件**: `src/account/points_detector.py#L19-L30, #L165-L250`

---

### 4. OAuth 页面导航增强

**问题**: 任务发现时页面停留在 OAuth 授权页面  
**原因**: `_wait_for_dashboard` 导航失败后没有进一步处理  
**修复**: 添加页面内容检查和强制导航逻辑

**文件**: `src/tasks/task_parser.py#L75-L135`

---

### 5. 页面崩溃检测与恢复

**问题**: 登录检测和积分检测后页面崩溃  
**原因**: OAuth 授权页面在检测过程中发生导航  
**修复**: 添加页面状态检查和重建逻辑

**文件**: `src/infrastructure/ms_rewards_app.py#L234-L253`

---

## 测试结果

**最近运行**: 2026-02-14 20:58:17

- 登录检测: ✅ 成功
- 积分检测: ✅ 成功 (初始积分: 915)
- 桌面搜索: ✅ 1/1 成功
- 移动搜索: ✅ 1/1 成功
- 日常任务: ✅ 发现 2 个任务（0积分任务已跳过）
- 搜索计数: ✅ 正确显示
- 搜索成功率: 100.0%

---

## 模块状态

| 模块 | 状态 | 备注 |
|------|------|------|
| 任务模块 | ✅ 正常 | TaskManager 已注册 3 种任务类型 |
| 登录检测 | ✅ 正常 | 多重检测机制工作正常 |
| 积分检测 | ✅ 正常 | 精确匹配用户积分，避免礼品卡面值干扰 |
| 任务发现 | ✅ 正常 | OAuth 和 Cookie 弹窗处理已修复 |
| 搜索计数 | ✅ 正常 | 监控禁用时也能正确计数 |
| 状态显示 | ✅ 正常 | NoneType 检查已修复 |
