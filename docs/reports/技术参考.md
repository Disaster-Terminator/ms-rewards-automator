# MS-Rewards-Automator 技术参考

> 本文档提取自项目审查报告，保留有价值的技术参考内容

---

## 一、反检测策略

### 8层 JavaScript 反检测脚本

```python
# 位置: src/browser/anti_ban_module.py

scripts = [
    # 1. 隐藏 webdriver 标志
    """
    Object.defineProperty(navigator, 'webdriver', {
        get: () => undefined
    });
    """,
    
    # 2. 修改 plugins 长度
    """
    Object.defineProperty(navigator, 'plugins', {
        get: () => [1, 2, 3, 4, 5]
    });
    """,
    
    # 3. 修改 languages
    """
    Object.defineProperty(navigator, 'languages', {
        get: () => ['en-US', 'en', 'zh-CN', 'zh']
    });
    """,
    
    # 4. 覆盖 permissions API
    """
    const originalQuery = window.navigator.permissions.query;
    window.navigator.permissions.query = (parameters) => (
        parameters.name === 'notifications' ?
            Promise.resolve({ state: Notification.permission }) :
            originalQuery(parameters)
    );
    """,
    
    # 5. 修改 chrome 对象
    """
    window.chrome = {
        runtime: {},
        loadTimes: function() {},
        csi: function() {},
        app: {}
    };
    """,
    
    # 6. 覆盖 navigator.platform
    """
    Object.defineProperty(navigator, 'platform', {
        get: () => 'Win32'
    });
    """,
    
    # 7. 修改 hardwareConcurrency
    """
    Object.defineProperty(navigator, 'hardwareConcurrency', {
        get: () => 8
    });
    """,
    
    # 8. 修改 deviceMemory
    """
    Object.defineProperty(navigator, 'deviceMemory', {
        get: () => 8
    });
    """,
]
```

### 人类行为模拟

- **随机等待时间**: 加权随机分布，避免固定间隔
- **滚动行为**: 缓动滚动效果，随机距离和停留时间
- **打字速度**: 50-150ms/字符，偶尔思考停顿
- **视口随机化**: 基础尺寸 ±10% 范围

---

## 二、安全建议

### 2.1 敏感信息加密

**问题**: `config.yaml` 中的密码和 token 明文存储

**建议方案**:

```python
import os
from cryptography.fernet import Fernet

# 方案1: 环境变量
password = os.getenv("MS_REWARDS_PASSWORD")

# 方案2: 加密存储
cipher = Fernet(key)
encrypted_password = cipher.encrypt(password.encode())
```

### 2.2 TOTP 密钥保护

**建议**: 使用系统密钥链
- Windows: Credential Manager
- macOS: Keychain

### 2.3 日志脱敏

```python
import re
import logging

class SensitiveDataFilter(logging.Filter):
    def filter(self, record):
        record.msg = re.sub(r'password=\S+', 'password=***', record.msg)
        record.msg = re.sub(r'totp_secret=\S+', 'totp_secret=***', record.msg)
        return True

# 应用过滤器
handler = logging.StreamHandler()
handler.addFilter(SensitiveDataFilter())
```

---

## 三、最佳实践

### 3.1 配置验证器

**位置**: `src/infrastructure/config_validator.py`

**特点**:
- 启动时自动验证配置
- 提供清晰的错误信息
- 自动修复常见问题

```python
validator = ConfigValidator(config)
is_valid, errors, warnings = validator.validate_config(config.config)

if not is_valid:
    fixed_config = validator.fix_common_issues(config.config)
```

### 3.2 元素检测器

**位置**: `src/browser/element_detector.py`

**特点**: 11种选择器级联降级

```python
SEARCH_BOX_SELECTORS = [
    'input[name="q"]',
    '#sb_form_q',
    'input[type="search"]',
    '.b_searchbox',
    '#sb_form_q_clone',
    'textarea[name="q"]',
    '[aria-label*="search"]',
    '[placeholder*="search"]',
    '.searchbox',
    '#id_q',
    'input[role="combobox"]',
]
```

**价值**: 应对页面频繁变化，提高定位成功率

### 3.3 防焦点机制

**位置**: `src/browser/simulator.py`, `src/browser/anti_focus_scripts.py`

**特点**: 两级防护

```python
# Enhanced 模式 - 完全阻止
await page.evaluate("""
    Object.defineProperty(window, 'focus', {
        value: function() { return false; }
    });
""")

# Basic 模式 - 轻量级
await context.add_init_script(anti_focus_script)
```

**配置**:
```yaml
browser:
  prevent_focus: "enhanced"  # 或 "basic"
```

---

## 四、测试策略

### 测试标记

```python
@pytest.mark.unit        # 单元测试
@pytest.mark.integration # 集成测试
@pytest.mark.e2e         # 端到端测试
@pytest.mark.property    # 属性测试 (hypothesis)
@pytest.mark.slow        # 慢测试
@pytest.mark.real        # 真实浏览器测试
```

### 测试覆盖率

```ini
# pytest.ini
[pytest]
addopts = --cov=src --cov-report=html --cov-report=term
```

---

## 五、性能优化建议

### 5.1 异步并发

```python
# 多数据源并发获取
tasks = [source.fetch_queries(count) for source in self.sources]
results = await asyncio.gather(*tasks)
```

### 5.2 缓存机制

```python
# QueryCache - TTL缓存
from diskcache import Cache
cache = Cache('.cache')
```

### 5.3 健康监控优化

```python
# 动态调整检查频率
interval = 60 if health_status == "healthy" else 30
```

---

*最后更新: 2026-02-15*
