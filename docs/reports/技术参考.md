# MS-Rewards-Automator æŠ€æœ¯å‚è€ƒ

> æœ€åæ›´æ–°: 2026-02-17
>
> æœ¬æ–‡æ¡£æå–è‡ªé¡¹ç›®å®¡æŸ¥æŠ¥å‘Šï¼Œä¿ç•™æœ‰ä»·å€¼çš„æŠ€æœ¯å‚è€ƒå†…å®¹ã€‚
> ç›¸å…³å¼€å‘æŠ¥å‘Šå·²å½’æ¡£è‡³ `reports/archive/` ç›®å½•ã€‚

---

## ä¸€ã€åæ£€æµ‹ç­–ç•¥

### 8å±‚ JavaScript åæ£€æµ‹è„šæœ¬

```python
# ä½ç½®: src/browser/anti_ban_module.py

scripts = [
    # 1. éšè— webdriver æ ‡å¿—
    """
    Object.defineProperty(navigator, 'webdriver', {
        get: () => undefined
    });
    """,
    
    # 2. ä¿®æ”¹ plugins é•¿åº¦
    """
    Object.defineProperty(navigator, 'plugins', {
        get: () => [1, 2, 3, 4, 5]
    });
    """,
    
    # 3. ä¿®æ”¹ languages
    """
    Object.defineProperty(navigator, 'languages', {
        get: () => ['en-US', 'en', 'zh-CN', 'zh']
    });
    """,
    
    # 4. è¦†ç›– permissions API
    """
    const originalQuery = window.navigator.permissions.query;
    window.navigator.permissions.query = (parameters) => (
        parameters.name === 'notifications' ?
            Promise.resolve({ state: Notification.permission }) :
            originalQuery(parameters)
    );
    """,
    
    # 5. ä¿®æ”¹ chrome å¯¹è±¡
    """
    window.chrome = {
        runtime: {},
        loadTimes: function() {},
        csi: function() {},
        app: {}
    };
    """,
    
    # 6. è¦†ç›– navigator.platform
    """
    Object.defineProperty(navigator, 'platform', {
        get: () => 'Win32'
    });
    """,
    
    # 7. ä¿®æ”¹ hardwareConcurrency
    """
    Object.defineProperty(navigator, 'hardwareConcurrency', {
        get: () => 8
    });
    """,
    
    # 8. ä¿®æ”¹ deviceMemory
    """
    Object.defineProperty(navigator, 'deviceMemory', {
        get: () => 8
    });
    """,
]
```

### äººç±»è¡Œä¸ºæ¨¡æ‹Ÿ

- **éšæœºç­‰å¾…æ—¶é—´**: åŠ æƒéšæœºåˆ†å¸ƒï¼Œé¿å…å›ºå®šé—´éš”
- **æ»šåŠ¨è¡Œä¸º**: ç¼“åŠ¨æ»šåŠ¨æ•ˆæœï¼Œéšæœºè·ç¦»å’Œåœç•™æ—¶é—´
- **æ‰“å­—é€Ÿåº¦**: 50-150ms/å­—ç¬¦ï¼Œå¶å°”æ€è€ƒåœé¡¿
- **è§†å£éšæœºåŒ–**: åŸºç¡€å°ºå¯¸ Â±10% èŒƒå›´

---

## äºŒã€å®‰å…¨å»ºè®®

### 2.1 æ•æ„Ÿä¿¡æ¯åŠ å¯†

**é—®é¢˜**: `config.yaml` ä¸­çš„å¯†ç å’Œ token æ˜æ–‡å­˜å‚¨

**å»ºè®®æ–¹æ¡ˆ**:

```python
import os
from cryptography.fernet import Fernet

# æ–¹æ¡ˆ1: ç¯å¢ƒå˜é‡
password = os.getenv("MS_REWARDS_PASSWORD")

# æ–¹æ¡ˆ2: åŠ å¯†å­˜å‚¨
cipher = Fernet(key)
encrypted_password = cipher.encrypt(password.encode())
```

### 2.2 TOTP å¯†é’¥ä¿æŠ¤

**å»ºè®®**: ä½¿ç”¨ç³»ç»Ÿå¯†é’¥é“¾
- Windows: Credential Manager
- macOS: Keychain

### 2.3 æ—¥å¿—è„±æ•

```python
import re
import logging

class SensitiveDataFilter(logging.Filter):
    def filter(self, record):
        record.msg = re.sub(r'password=\S+', 'password=***', record.msg)
        record.msg = re.sub(r'totp_secret=\S+', 'totp_secret=***', record.msg)
        return True

# åº”ç”¨è¿‡æ»¤å™¨
handler = logging.StreamHandler()
handler.addFilter(SensitiveDataFilter())
```

---

## ä¸‰ã€æœ€ä½³å®è·µ

### 3.1 é…ç½®éªŒè¯å™¨

**ä½ç½®**: `src/infrastructure/config_validator.py`

**ç‰¹ç‚¹**:
- å¯åŠ¨æ—¶è‡ªåŠ¨éªŒè¯é…ç½®
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- è‡ªåŠ¨ä¿®å¤å¸¸è§é—®é¢˜

```python
validator = ConfigValidator(config)
is_valid, errors, warnings = validator.validate_config(config.config)

if not is_valid:
    fixed_config = validator.fix_common_issues(config.config)
```

### 3.2 å…ƒç´ æ£€æµ‹å™¨

**ä½ç½®**: `src/browser/element_detector.py`

**ç‰¹ç‚¹**: 11ç§é€‰æ‹©å™¨çº§è”é™çº§

```python
SEARCH_BOX_SELECTORS = [
    'input[name="q"]',
    '#sb_form_q',
    'input[type="search"]',
    '.b_searchbox',
    '#sb_form_q_clone',
    'textarea[name="q"]',
    '[aria-label*="search"]',
    '[placeholder*="search"]',
    '.searchbox',
    '#id_q',
    'input[role="combobox"]',
]
```

**ä»·å€¼**: åº”å¯¹é¡µé¢é¢‘ç¹å˜åŒ–ï¼Œæé«˜å®šä½æˆåŠŸç‡

### 3.3 é˜²ç„¦ç‚¹æœºåˆ¶

**ä½ç½®**: `src/browser/simulator.py`, `src/browser/anti_focus_scripts.py`

**ç‰¹ç‚¹**: ä¸¤çº§é˜²æŠ¤

```python
# Enhanced æ¨¡å¼ - å®Œå…¨é˜»æ­¢
await page.evaluate("""
    Object.defineProperty(window, 'focus', {
        value: function() { return false; }
    });
""")

# Basic æ¨¡å¼ - è½»é‡çº§
await context.add_init_script(anti_focus_script)
```

**é…ç½®**:
```yaml
browser:
  prevent_focus: "enhanced"  # æˆ– "basic"
```

---

## å››ã€æµ‹è¯•ç­–ç•¥

### æµ‹è¯•æ ‡è®°

```python
@pytest.mark.unit        # å•å…ƒæµ‹è¯•
@pytest.mark.integration # é›†æˆæµ‹è¯•
@pytest.mark.e2e         # ç«¯åˆ°ç«¯æµ‹è¯•
@pytest.mark.property    # å±æ€§æµ‹è¯• (hypothesis)
@pytest.mark.slow        # æ…¢æµ‹è¯•
@pytest.mark.real        # çœŸå®æµè§ˆå™¨æµ‹è¯•
```

### æµ‹è¯•è¦†ç›–ç‡

```ini
# pytest.ini
[pytest]
addopts = --cov=src --cov-report=html --cov-report=term
```

---

## äº”ã€å¥åº·ç›‘æ§ä¸è¿›åº¦è·Ÿè¸ª

### 5.1 å¥åº·ç›‘æ§ç³»ç»Ÿ

**ä½ç½®**: `src/infrastructure/health_monitor.py`

**åŠŸèƒ½**:
- ç³»ç»Ÿèµ„æºç›‘æ§ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰
- ç½‘ç»œå¥åº·æ£€æŸ¥
- æµè§ˆå™¨å¥åº·æ£€æŸ¥ï¼ˆå†…å­˜ã€é¡µé¢æ•°ï¼‰
- æ•´ä½“å¥åº·çŠ¶æ€è¯„ä¼°

**çŠ¶æ€åˆ¤æ–­é€»è¾‘**:
```
æµè§ˆå™¨çŠ¶æ€:
â”œâ”€â”€ æœªæ³¨å†Œæµè§ˆå™¨ â†’ "unknown" (ä¸å½±å“æ€»ä½“è¯„ä¼°)
â”œâ”€â”€ è¿æ¥æ­£å¸¸ + å†…å­˜æ­£å¸¸ + é¡µé¢æ•°æ­£å¸¸ â†’ "healthy"
â”œâ”€â”€ è¿æ¥æ­£å¸¸ + å†…å­˜/é¡µé¢æ•°å¼‚å¸¸ â†’ "warning"
â””â”€â”€ è¿æ¥å¤±è´¥ â†’ "error"
```

### 5.2 é˜¶æ®µåŒ–è¿›åº¦è·Ÿè¸ª

**ä½ç½®**: `src/ui/real_time_status.py`

**ProgressTracker ç±»**:

| é˜¶æ®µ | åç§° | æƒé‡ |
|------|------|------|
| `init` | åˆå§‹åŒ– | 5% |
| `login` | ç™»å½• | 10% |
| `desktop_search` | æ¡Œé¢æœç´¢ | 40% |
| `mobile_search` | ç§»åŠ¨æœç´¢ | 35% |
| `daily_tasks` | æ—¥å¸¸ä»»åŠ¡ | 10% |

**æ™ºèƒ½æ—¶é—´ä¼°ç®—**:
- åŸºäºå†å²é˜¶æ®µè€—æ—¶
- åŸºäºå®é™…æœç´¢é€Ÿåº¦
- æ˜¾ç¤ºä¸‹ä¸€é˜¶æ®µåç§°

**ä½¿ç”¨æ–¹å¼**:
```python
from ui.real_time_status import StatusManager

StatusManager.start_stage("desktop_search")
StatusManager.update_stage_progress("desktop_search", 0.5)  # 50%
StatusManager.complete_stage("desktop_search")
```

### 5.3 å®æ—¶çŠ¶æ€æ˜¾ç¤º

**ç‰¹ç‚¹**:
- 1ç§’åˆ·æ–°é—´éš”
- ANSI è½¬ä¹‰ç æ¸…å±ï¼ˆé¿å…æ—¥å¿—å¹²æ‰°ï¼‰
- åº•éƒ¨æ—¥å¿—é¢æ¿ï¼ˆæœ€è¿‘5æ¡ï¼‰
- è¿›åº¦æ¡å¯è§†åŒ–

**æ˜¾ç¤ºæ•ˆæœ**:
```
ğŸ¤– MS Rewards Automator - å®æ—¶çŠ¶æ€
============================================================
ğŸ“‹ å½“å‰é˜¶æ®µ: æ¡Œé¢æœç´¢
   æ“ä½œ: æ‰§è¡Œæœç´¢...
ğŸ“Š æ€»ä½“è¿›åº¦: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 42.5%
ğŸ–¥ï¸  æ¡Œé¢æœç´¢: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 15/30
â±ï¸  è¿è¡Œæ—¶é—´: 2åˆ†30ç§’
â³ é¢„è®¡å‰©ä½™: 3åˆ†15ç§’ (ä¸‹ä¸€é˜¶æ®µ: ç§»åŠ¨æœç´¢)
============================================================
ğŸ“ æœ€è¿‘æ—¥å¿—:
   INFO: æœç´¢å®Œæˆ: pythonæ•™ç¨‹
   INFO: å¼€å§‹æœç´¢: javaç¼–ç¨‹
------------------------------------------------------------
ğŸ’¡ æç¤º: æŒ‰ Ctrl+C å¯ä»¥å®‰å…¨åœæ­¢ç¨‹åº
```

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 6.1 å¼‚æ­¥å¹¶å‘

```python
# å¤šæ•°æ®æºå¹¶å‘è·å–
tasks = [source.fetch_queries(count) for source in self.sources]
results = await asyncio.gather(*tasks)
```

### 6.2 ç¼“å­˜æœºåˆ¶

```python
# QueryCache - TTLç¼“å­˜
from diskcache import Cache
cache = Cache('.cache')
```

### 6.3 å¥åº·ç›‘æ§ä¼˜åŒ–

```python
# åŠ¨æ€è°ƒæ•´æ£€æŸ¥é¢‘ç‡
interval = 60 if health_status == "healthy" else 30
```

---

*æœ€åæ›´æ–°: 2026-02-17*
