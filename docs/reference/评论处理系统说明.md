# 评论处理系统说明

> 最后更新: 2026-02-24
>
> **注意**：本文档为人类参考文档，介绍评论处理系统的架构和数据模型。
> Agent 请使用 [review-workflow Skill](../../.trae/skills/review-workflow/SKILL.md)。

## 概述

评论处理系统用于获取和处理 AI 审查工具（Sourcery/Qodo/Copilot）的评论，提供统一的 CLI 接口和结构化数据存储。

## 架构

### 核心原则

| 原则 | 说明 |
|------|------|
| **Single Source of Truth** | GitHub Thread 是核心操作对象 |
| **API First, DB Second** | 先调用 GitHub API，成功后更新本地数据库 |
| **Thread 为主，Overview 为辅** | Thread 是操作对象，Overview 是只读参考 |

### 数据流

```
GitHub API → GraphQL Client → Resolver → Manager → TinyDB
                ↓
         ReviewThreadState (Thread + enriched_context)
         ReviewOverview (只读参考)
         IssueCommentOverview (只读参考)
```

### 模块结构

```
src/review/
├── models.py           # 数据模型定义
├── parsers.py          # 评论解析器
├── graphql_client.py   # GitHub GraphQL API 客户端
├── resolver.py         # 评论解决器（核心逻辑）
└── comment_manager.py  # 数据持久化管理器
```

## 数据模型

### ReviewThreadState（核心操作对象）

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | str | Thread ID（用于解决操作） |
| `source` | str | 来源：Sourcery / Qodo / Copilot |
| `local_status` | str | 状态：pending / resolved / ignored |
| `is_resolved` | bool | GitHub 上的解决状态（只读） |
| `file_path` | str | 文件路径 |
| `line_number` | int \| None | 行号，None 表示文件级评论 |
| `primary_comment_body` | str | 评论内容 |
| `enriched_context` | EnrichedContext | 结构化元数据（可选） |
| `resolution_type` | str | 解决依据类型 |

### EnrichedContext

| 字段 | 类型 | 说明 |
|------|------|------|
| `issue_type` | str | 问题类型（Bug / Security / suggestion 等） |
| `issue_to_address` | str | 问题描述（来自 Sourcery Prompt） |
| `code_context` | str | 代码上下文（来自 Sourcery Prompt） |

### ReviewOverview（只读参考）

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | str | Review ID |
| `source` | str | 来源 |
| `high_level_feedback` | list | 高层建议 |
| `has_prompt_for_ai` | bool | 是否包含 Prompt for AI Agents |
| `prompt_overall_comments` | list | Overall Comments |

### IssueCommentOverview（只读参考）

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | str | Issue Comment ID |
| `source` | str | 来源（Qodo） |
| `user_login` | str | 评论者用户名 |

## CLI 命令

### 获取评论

```bash
python tools/manage_reviews.py fetch --owner OWNER --repo REPO --pr PR_NUMBER
```

### 列出评论

```bash
# 表格格式（默认）
python tools/manage_reviews.py list --status pending

# JSON 格式
python tools/manage_reviews.py list --status pending --format json
```

### 解决评论

```bash
python tools/manage_reviews.py resolve --thread-id THREAD_ID --type RESOLUTION_TYPE [--reply "回复内容"]
```

### 确认总览意见

```bash
python tools/manage_reviews.py acknowledge --all
```

## 三种 AI 审查工具

| 工具 | GitHub 用户名 | 特点 |
|------|--------------|------|
| **Sourcery** | `sourcery-ai bot` | 结构化摘要（Prompt for AI Agents），动态解决状态 |
| **Qodo** | `qodo-code-review bot` | 逐行评论（Review Thread），无法通过 @ 解决 |
| **Copilot** | `Copilot AI` | 简单评论，无结构化摘要 |

## 数据存储

| 文件 | 说明 |
|------|------|
| `.trae/data/review_threads.json` | TinyDB 数据库 |
| `.trae/data/review_threads.lock` | 并发锁 |

## 降级策略

如果 CLI 工具失败，参考 `docs/reference/archive/v1-ai-reviewer-guide.md` 使用 Playwright 手动获取评论。

## 相关文档

- [review-workflow Skill](../../.trae/skills/review-workflow/SKILL.md) - Agent 完整工作流
- [fetch-reviews Skill](../../.trae/skills/fetch-reviews/SKILL.md) - 获取评论
- [resolve-review-comment Skill](../../.trae/skills/resolve-review-comment/SKILL.md) - 解决评论
