# 参数与调度器整改计划

## 一、问题诊断

### 1.1 命令行参数问题

| 参数 | 当前状态 | 问题 |
|------|----------|------|
| `--schedule` | 死代码 | 定义了但从未使用 |
| `--schedule-now` | 废弃 | 只打印日志，无实际功能 |
| `--schedule-only` | 冗余 | 用户可通过配置控制 |
| `--no-schedule` | 冗余 | 用户可直接禁用调度器 |
| `--mode` | 冗余 | 与 `--dev`/`--usermode` 功能重叠 |

### 1.2 调度器行为问题

**当前行为**：

- `python main.py` → 执行一次，退出（调度器默认禁用）
- 用户需要修改配置文件才能启用调度

**用户期望**：

- `python main.py` → 执行一次，等待调度（调度器默认启用）
- 想只执行一次就退出 → 配置中禁用调度器

### 1.3 调度器默认时间问题

| 配置项 | 当前值 | 问题 |
|--------|--------|------|
| `scheduled_hour` | 10 | 可能在积分重置前执行 |
| `max_offset_minutes` | 30 | 随机范围较小 |

**微软积分重置时间**：北京时间 15:00-16:00（太平洋时间午夜）

---

## 二、整改方案

### 2.1 参数精简方案

#### 保留给用户的参数（5个）

| 参数 | 说明 | 使用场景 |
|------|------|----------|
| `python main.py` | 标准运行 | 日常使用 |
| `--headless` | 后台运行 | 服务器/无人值守 |
| `--dev` | 开发模式 | 快速调试 |
| `--usermode` | 用户模式 | 稳定性测试 |
| `--browser` | 浏览器选择 | 特定需求 |

#### 移除的参数

| 参数 | 处理方式 | 理由 |
|------|----------|------|
| `--schedule` | 移除 | 死代码 |
| `--schedule-now` | 移除 | 废弃 |
| `--schedule-only` | 移除 | 用户可通过配置控制 |
| `--no-schedule` | 移除 | 用户可直接禁用调度器 |
| `--mode` | 移除 | 与 `--dev`/`--usermode` 重叠 |

#### 开发者专用参数（保留但文档分离）

| 参数 | 说明 |
|------|------|
| `--dry-run` | 模拟运行，不执行实际操作 |
| `--test-notification` | 测试通知功能 |
| `--autonomous-test` | 自主测试框架 |
| `--test-type` | 测试类型 |
| `--quick-test` | 快速测试 |
| `--desktop-only` | 仅桌面搜索 |
| `--mobile-only` | 仅移动搜索 |
| `--skip-daily-tasks` | 跳过每日任务 |

### 2.2 调度器行为调整

#### 默认值修改

| 配置项 | 修改前 | 修改后 | 理由 |
|--------|--------|--------|------|
| `scheduler.enabled` | `false` | `true` | 用户期望默认启用调度 |
| `scheduler.scheduled_hour` | `10` | `17` | 积分重置后执行 |
| `scheduler.max_offset_minutes` | `30` | `45` | 增加随机性 |

#### 行为对照表

| 场景 | 修改前 | 修改后 |
|------|--------|--------|
| `python main.py` | 执行一次 → 退出 | 执行一次 → 等待调度 |
| 调度器禁用时 | 执行一次 → 退出 | 执行一次 → 退出 |
| 想只执行一次 | 无直接方式 | 配置 `scheduler.enabled: false` |

### 2.3 调度器默认时间分析

**推荐时间：北京时间 17:00 ± 45分钟（16:15-17:45）**

| 因素 | 分析 |
|------|------|
| 积分重置 | 北京时间 15:00-16:00 重置，17:00 执行确保从零开始 |
| 服务器负载 | 美国凌晨时段，服务器最空闲 |
| 用户习惯 | 傍晚时段，用户更可能在线检查 |
| 随机性 | ±45分钟覆盖 90 分钟范围，足够避免检测 |

---

## 三、代码修改清单

### 3.1 main.py 修改

```python
# 移除以下参数定义（约 20 行）
--schedule        # 死代码
--schedule-now    # 废弃
--schedule-only   # 不再需要
--no-schedule     # 不再需要
--mode            # 与 --dev/--usermode 重叠

# 移除调度相关逻辑（第333-360行，约 30 行）
# 调度器行为完全由配置文件控制
```

### 3.2 config.example.yaml 修改

```yaml
scheduler:
  enabled: true                    # 改为 true
  timezone: "Asia/Shanghai"
  mode: "scheduled"
  run_once_on_start: true
  scheduled_hour: 17               # 改为 17
  max_offset_minutes: 45           # 改为 45
```

### 3.3 scheduler.py 修改

更新默认值以匹配 config.example.yaml

---

## 四、文档整改方案（详细）

### 4.1 整改原则

1. **不直接删除**：合并有用内容，精简文档
2. **用户/开发者分离**：用户只看需要的内容
3. **简洁高效**：每个文档聚焦单一主题

### 4.2 文档结构规划

```
docs/
├── README.md                    # 文档索引（更新导航）
├── guides/
│   └── 用户指南.md              # 用户专用（精简到 ~80 行）
└── reference/
    ├── BRANCH_GUIDE.md          # 开发者指南（更新参数表）
    ├── SCHEDULER.md             # 调度器文档（精简+更新默认值）
    └── CONFIG.md                # 配置参考（新建，合并配置说明）
```

### 4.3 各文档整改详情

#### 📄 README.md（根目录）- 需要修改

| 行号 | 当前内容 | 修改方式 |
|------|----------|----------|
| 196-199 | `--mode slow` 和 `--schedule` 参数 | 移除 |
| 202-206 | `--desktop-only` 和 `--mobile-only` | 移除 |
| 213-220 | `--dry-run` 和 `--skip-daily-tasks` | 移除 |
| 286-291 | 调度器配置示例 | 更新默认值（enabled: true, scheduled_hour: 17） |
| 313-314 | 安全建议中的 `--mode slow` 和 `--schedule` | 移除，改为配置说明 |

**精简后的常用命令部分**：

```bash
# 生产环境（完整搜索，自动调度）
python main.py

# 后台运行（服务器部署）
python main.py --headless

# 测试模式（3+3搜索，验证稳定性）
python main.py --usermode

# 开发模式（快速迭代）
python main.py --dev
```

#### 📄 docs/README.md - 需要修改

| 行号 | 当前内容 | 修改方式 |
|------|----------|----------|
| 21 | 调度器文档链接 | 保留 |
| - | - | 新增 CONFIG.md 导航链接 |
| 48-60 | 文档结构说明 | 更新，添加 CONFIG.md |

**新增内容**：

```markdown
| [配置参考](reference/CONFIG.md) | 完整配置项说明和示例 |
```

#### 📄 docs/guides/用户指南.md - 需要精简

**当前内容**（124行）：

- 快速开始
- 命令行参数（包含开发者参数）
- 配置文件
- 故障排除
- 最佳实践

**整改后**（~80行）：

- 快速开始（保留）
- 常用参数（仅5个）
- 基础配置示例（精简）
- 故障排除（保留）

**移除内容**：

- `--mode`, `--schedule`, `--schedule-now`, `--no-schedule` 等
- `--dry-run`, `--test-notification`, `--autonomous-test` 等
- `--desktop-only`, `--mobile-only`, `--skip-daily-tasks`
- 详细调度器配置 → SCHEDULER.md

#### 📄 docs/reference/BRANCH_GUIDE.md - 需要更新

| 行号 | 当前内容 | 修改方式 |
|------|----------|----------|
| 362 | `--dry-run` 参数说明 | 保留 |
| 370-375 | 调度参数表（`--schedule`, `--schedule-now` 等） | 移除 |
| 381 | `--mode` 参数 | 移除 |
| 384-386 | `--desktop-only`, `--mobile-only`, `--skip-daily-tasks` | 保留（开发者参数） |
| 483-505 | 调度器行为说明 | 移除，合并到 SCHEDULER.md |

**更新后的参数表**：

```markdown
#### 执行模式

| 参数 | 搜索次数 | 拟人行为 | 防检测 | 日志级别 | 用途 |
|------|----------|----------|--------|----------|------|
| 默认 | 30+20 | ✅ | ✅ | INFO | 生产环境 |
| `--usermode` | 3+3 | ✅ | ✅ | INFO | 稳定性测试 |
| `--dev` | 2+2 | ❌ | ❌ | DEBUG | 快速调试 |

#### 测试参数

| 参数 | 说明 |
|------|------|
| `--dry-run` | 模拟运行，不执行实际操作 |
| `--test-notification` | 测试通知功能 |
| `--autonomous-test` | 运行自主测试框架 |
| `--test-type` | 测试类型 |
| `--quick-test` | 快速测试模式 |

#### 其他参数

| 参数 | 说明 |
|------|------|
| `--headless` | 无头模式 |
| `--browser` | 浏览器类型 |
| `--desktop-only` | 仅桌面搜索 |
| `--mobile-only` | 仅移动搜索 |
| `--skip-daily-tasks` | 跳过每日任务 |
| `--config` | 配置文件路径 |
```

#### 📄 docs/reference/SCHEDULER.md - 需要精简+更新

| 行号 | 当前内容 | 修改方式 |
|------|----------|----------|
| 19-24 | 基础配置示例 | 更新默认值（enabled: true, scheduled_hour: 17, max_offset_minutes: 45） |
| 102-109 | 命令行参数部分 | 移除（调度完全由配置控制） |
| 112-168 | 执行流程图 | 精简，移除命令行参数分支 |

**新增内容**（从 BRANCH_GUIDE.md 合并）：

```markdown
## 调度器行为说明

**默认行为**：
- `python main.py` → 执行一次 → 等待下次调度时间
- 调度器默认启用，默认执行时间：北京时间 17:00 ± 45分钟

**禁用调度器**：
```yaml
scheduler:
  enabled: false
```

**为什么默认启用**：

- 用户期望程序自动执行，无需手动干预
- 通过配置禁用比通过命令行启用更直观

```

#### 📄 docs/reference/CONFIG.md - 新建

**合并内容**：
- config.example.yaml 的详细说明
- 用户指南中的配置示例
- 各配置项的作用说明

**文档结构**：
```markdown
# 配置文件参考

## 一、搜索配置
## 二、浏览器配置
## 三、登录配置
## 四、调度器配置
## 五、通知配置
## 六、任务系统配置
## 七、监控配置
```

#### 📄 docs/reports/技术参考.md - 不需要修改

技术参考内容，与参数整改无关。

#### 📄 docs/reports/archive/*.md - 不需要修改

归档文档，保持原样。

---

## 五、文档改动汇总表

| 文档 | 改动类型 | 主要改动 |
|------|----------|----------|
| README.md | 精简 | 移除废弃参数，更新配置示例 |
| docs/README.md | 更新 | 添加 CONFIG.md 导航 |
| docs/guides/用户指南.md | 精简 | 从 124 行精简到 ~80 行 |
| docs/reference/BRANCH_GUIDE.md | 更新 | 移除废弃参数，移除调度器行为说明 |
| docs/reference/SCHEDULER.md | 精简+更新 | 更新默认值，移除命令行参数，合并行为说明 |
| docs/reference/CONFIG.md | 新建 | 合并配置说明 |
| docs/reports/技术参考.md | 无改动 | - |
| docs/reports/archive/*.md | 无改动 | - |

---

## 六、用户使用场景对照

### 6.1 典型用户场景

| 场景 | 操作 | 说明 |
|------|------|------|
| 日常使用 | `python main.py` | 执行一次，等待明天自动执行 |
| 服务器运行 | `python main.py --headless` | 后台运行，自动调度 |
| 快速测试 | `python main.py --dev` | 快速执行一次，不进入调度 |
| 只执行一次 | 配置 `scheduler.enabled: false` | 禁用调度器 |

### 6.2 开发者场景

| 场景 | 操作 |
|------|------|
| 模拟运行 | `python main.py --dry-run` |
| 测试通知 | `python main.py --test-notification` |
| 自主测试 | `python main.py --autonomous-test` |
| 仅桌面搜索 | `python main.py --desktop-only` |

---

## 七、执行顺序

### 阶段 1：代码修改

1. main.py 移除冗余参数
2. scheduler.py 更新默认值
3. config.example.yaml 更新默认值

### 阶段 2：文档整改

1. 精简 README.md（根目录）
2. 更新 docs/README.md 导航
3. 精简 docs/guides/用户指南.md
4. 更新 docs/reference/BRANCH_GUIDE.md
5. 精简+更新 docs/reference/SCHEDULER.md
6. 新建 docs/reference/CONFIG.md

### 阶段 3：测试验证

1. 运行测试确保无回归
2. 验证调度器行为正确

---

## 八、风险评估

### 8.1 破坏性变更

| 变更 | 影响 | 缓解措施 |
|------|------|----------|
| 移除调度参数 | 依赖这些参数的用户 | 文档说明迁移方式 |
| 调度器默认启用 | 现有用户可能不期望 | 配置文件中明确说明 |

### 8.2 兼容性

- 配置文件格式不变
- 现有配置继续有效
- 只需更新 config.example.yaml

---

## 九、已确认事项

- [x] 移除 `--schedule`, `--schedule-now`, `--schedule-only`, `--no-schedule`, `--mode` 参数
- [x] 调度器默认启用（`enabled: true`）
- [x] 默认执行时间改为 17:00 ± 45分钟
- [x] 开发者参数移到 BRANCH_GUIDE.md
- [x] 不直接删除，合并有用内容，精简文档
- [x] 新建 CONFIG.md 合并配置说明
