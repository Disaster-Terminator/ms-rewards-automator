# 多Agent框架问题分析合集

> 整理日期：2026-02-24
> 来源：合并 `skill加载时机与约束传递问题分析.md` + `test-agent-execution-analysis.md`

---

## 一、Skill 加载时机与约束传递问题

### 问题背景

发现两个相关联的架构问题：

1. **test-agent 没有正确报告 rscore 入口点问题** - 降级策略缺乏"失败原因分离"
2. **Agent 阅读 Skill 的时机不明确** - 可能导致 Agent 缺少信息和约束

### 问题 1：降级策略缺乏失败原因分离

**当前设计**：

| rscore 结果 | python main.py 结果 | 结论 |
|-------------|---------------------|------|
| ❌ 失败 | ❌ 失败 | 业务逻辑问题 |

**问题**：当两个都失败时，直接归因为"业务逻辑问题"，没有区分失败原因。

**真实情况**：

| 命令 | 失败原因 | test-agent 判断 |
|------|----------|-----------------|
| rscore | 入口点配置错误（ModuleNotFoundError） | 未单独记录 |
| python main.py | 运行时依赖缺失（会话文件） | 业务逻辑问题 |

### 问题 2：Agent 阅读 Skill 的时机不明确

**"按需加载"是模糊的**：

| 问题 | 影响 |
|------|------|
| 什么时候算"需要"？ | Agent 自行判断，可能跳过 |
| 如果 Agent 认为不需要？ | Skill 中的约束不会生效 |
| Skill 包含什么？ | 前置检查、阻断协议、详细流程 |

**约束传递链分析**：

```
┌─────────────────────────────────────────────────────────────┐
│  Agent 提示词（始终生效）                                     │
│  - 高层约束：禁止猜测、禁止写入 Memory MCP                     │
│  - 状态标签输出规则                                          │
│  - 执行流程（简略）                                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Skill（按需加载，可能不生效）                                │
│  - 前置检查（强制拦截）                                       │
│  - 环境异常阻断协议                                          │
│  - 详细执行流程                                              │
│  - 错误归因表                                                │
└─────────────────────────────────────────────────────────────┘
```

**关键发现**：前置检查在 Skill 中，但 Agent 可能不阅读 Skill，导致前置检查不生效。

### 改进方案

1. **增强降级策略**：修复 test-agent 的问题报告，区分失败原因
2. **强制 Skill 加载**：确保 Agent 不会跳过 Skill
3. **关键约束上移**：将前置检查放入 Agent 提示词，作为"双重保险"

---

## 二、test-agent 执行问题分析

### 核心问题

**Master Agent 无法看到子 agent 的执行过程，只能看到最终结果**

这导致：
1. 无法判断 test-agent 是否正确执行了任务
2. 无法发现 test-agent 的决策错误
3. 需要用户提醒才能发现问题

### test_report.md 矛盾分析

#### 矛盾 1：阶段 5 状态不一致

报告说"跳过（无会话文件）"，但后面又写了失败信息。

**结论**：test-agent 实际执行了阶段 5，失败了，但报告说"跳过"。

#### 矛盾 2：会话文件判断错误

用户说"事实上有会话文件"，但 test-agent 判断"无会话文件"。

**可能原因**：
1. test-agent 没有检查会话文件是否存在
2. 检查路径错误
3. 二维矩阵干扰了判断流程

#### 矛盾 3：没有使用 Playwright MCP

test-execution/SKILL.md 明确说"测试失败时使用 Playwright MCP"，但 test-agent 完全没有调用。

### 根因分析

#### 问题 1：二维矩阵干扰了流程

二维矩阵的第一行：rscore 成功 → 验证通过

test-agent 看到 rscore 成功，就直接判定"验证通过"，跳过了：
- 检查会话文件
- 执行阶段 5
- 使用 Playwright MCP 观察

#### 问题 2：Skill 与实际执行不一致

SKILL.md 说"测试失败时使用 Playwright MCP"，但：
- 阶段 4 rscore 成功 → 没触发
- 阶段 5 失败 → 应该触发，但没有

#### 问题 3：Master Agent 缺乏监控能力

看不到子 agent 的执行过程，无法验证报告是否准确。

### 改进方向

1. **增强 Master Agent 监控能力**：子 agent 返回详细执行日志
2. **修正二维矩阵逻辑**：rscore 成功 → 检查会话文件 → 执行阶段 5
3. **明确 Playwright MCP 使用时机**：每次 E2E 测试都调用，失败时额外取证

---

## 三、总结

| 问题类型 | 具体问题 | 影响 |
|----------|----------|------|
| 约束传递 | Skill 按需加载可能被跳过 | 前置检查不生效 |
| 错误归因 | 降级策略缺乏失败原因分离 | 问题定位不准确 |
| 执行监控 | Master Agent 看不到子 agent 执行过程 | 无法发现决策错误 |
| 流程设计 | 二维矩阵简化了判断逻辑 | 跳过必要步骤 |

**核心教训**：
1. 关键约束应上移到 Agent 提示词（始终生效）
2. Skill 加载应改为强制
3. 子 agent 应返回详细执行日志
4. 流程设计应避免过度简化
