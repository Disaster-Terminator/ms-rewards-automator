# 多智能体协作框架全面分析报告 v2

> 分析日期：2026-02-23
> 分析范围：`.trae/` 目录下所有配置文件、Skills、Specs
> 分析版本：基于 state-machine-terminal spec 的最终版本

---

## 一、架构深度分析

### 1.1 三层控制流架构验证 ✅

框架采用清晰的三层控制流设计，职责边界明确：

```
┌─────────────────────────────────────────────────────────────────────┐
│                    第一层：全局 Rule（路由器与总线）                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  project_rules.md                                            │   │
│  │  - Master Watchdog v2.0（输出格式强制校验）                    │   │
│  │  - 状态标签字典（5 种标签，含终止状态）                          │   │
│  │  - 通信媒介定义（3 个文件）                                     │   │
│  │  - 媒介文件覆写策略                                            │   │
│  │  - 身份判定规则                                               │   │
│  │  - AI 审查处理规则                                            │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  第二层：子 Agent 配置（API 接口）                     │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────┐ │
│  │  master.md   │ │ dev-agent.md │ │test-agent.md │ │docs-agent.md│ │
│  │              │ │              │ │              │ │            │ │
│  │ - Identity   │ │ - Identity   │ │ - Identity   │ │ - Identity │ │
│  │ - Permissions│ │ - Constraints│ │ - Constraints│ │- Constraints│ │
│  │ - Constraints│ │ - Execution  │ │ - Execution  │ │- Execution │ │
│  │ - Routing    │ │ - Routing    │ │ - Routing    │ │- Routing   │ │
│  │ - 指针引用   │ │ - MCP配置    │ │ - MCP配置    │ │- MCP配置   │ │
│  └──────────────┘ └──────────────┘ └──────────────┘ └────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  第三层：Skill 文件（执行引擎）                        │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐          │
│  │master-execution│ │ dev-execution  │ │test-execution  │          │
│  │                │ │                │ │                │          │
│  │ - 任务分发流程  │ │ - 局部验证     │ │ - 环境诊断     │          │
│  │ - 熔断器检查   │ │ - 禁止猜测     │ │ - 降级执行     │          │
│  │ - 微提交保护   │ │ - 阻塞协议     │ │ - 精简取证     │          │
│  │ - 路由决策树   │ │ - 重试计数     │ │ - 截图落盘     │          │
│  └────────────────┘ └────────────────┘ └────────────────┘          │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐          │
│  │docs-execution  │ │master-recovery │ │ mcp-acceptance │          │
│  └────────────────┘ └────────────────┘ └────────────────┘          │
│  ┌────────────────┐ ┌────────────────┐                             │
│  │  pr-review     │ │ fetch-reviews  │                             │
│  └────────────────┘ └────────────────┘                             │
└─────────────────────────────────────────────────────────────────────┘
```

**架构评价**：三层边界清晰，符合"单一职责"和"最小知识"原则。

### 1.2 角色矩阵验证 ✅

| 角色 | 英文标识 | 核心职责 | GitHub MCP | Memory MCP | Playwright MCP |
|------|----------|----------|------------|------------|----------------|
| **Master Agent** | `solo coder` | 任务路由、PR管理、Git操作 | 读写 | 读写 | ❌ 无 |
| **dev-agent** | `dev-agent` | 业务代码编写与局部验证 | 只读 | 只读 | ❌ 无 |
| **test-agent** | `test-agent` | 全量测试与 E2E 验收 | ❌ 无 | 只读 | 全量 (33工具) |
| **docs-agent** | `docs-agent` | 文档同步与维护 | 只读 | 只读 | ❌ 无 |

**权限设计评价**：遵循最小权限原则，每个 Agent 只拥有完成任务所需的最小权限。

### 1.3 Skills 调用关系图 ✅

```
                        Master Agent
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
   master-execution    mcp-acceptance      pr-review
         │                   │                   │
         │                   │                   ▼
         │                   │            fetch-reviews
         │                   │
    ┌────┴────┬────────┬─────┘
    ▼         ▼        ▼
dev-agent  test-agent  docs-agent
    │         │          │
    ▼         ▼          ▼
dev-exec  test-exec  docs-exec
    │         │
    │         ▼
    │   master-recovery
    │    (当 BLOCK 时)
    ▼
[BLOCK_NEED_MASTER]
```

**调用关系评价**：层级清晰，依赖关系明确，无循环依赖。

---

## 二、状态机完整性验证

### 2.1 状态标签字典 ✅

| 标签 | 含义 | 触发者 | 响应动作 |
|------|------|--------|----------|
| `[REQ_DEV]` | 需要修改业务代码 | Master / test-agent | 唤醒 dev-agent |
| `[REQ_TEST]` | 需要执行测试验证 | Master / dev-agent | 唤醒 test-agent |
| `[REQ_DOCS]` | 需要同步文档 | Master / test-agent | 唤醒 docs-agent |
| `[BLOCK_NEED_MASTER]` | 子任务受阻，需移交决策 | 任意子 Agent | 移交 Master Agent |
| `[TASK_DONE]` | 任务完成，等待用户指令 | Master Agent | 无动作，停止流转 |

**关键改进**：已新增 `[TASK_DONE]` 终止标签，完善状态机闭环。

### 2.2 状态转换图 ✅

```
                              ┌─────────────────┐
                              │   用户请求       │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  Master Agent   │
                              │  (任务路由)      │
                              └────────┬────────┘
                                       │
              ┌────────────────────────┼────────────────────────┐
              │                        │                        │
              ▼                        ▼                        ▼
     ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
     │   [REQ_DEV]     │      │   [REQ_TEST]    │      │   [REQ_DOCS]    │
     │   代码修改       │      │   测试验收       │      │   文档更新       │
     └────────┬────────┘      └────────┬────────┘      └────────┬────────┘
              │                        │                        │
              ▼                        ▼                        ▼
     ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
     │   dev-agent     │      │   test-agent    │      │   docs-agent    │
     │   修改代码       │      │   执行测试       │      │   更新文档       │
     └────────┬────────┘      └────────┬────────┘      └────────┬────────┘
              │                        │                        │
              │                        │                        │
              ▼                        ▼                        ▼
     ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
     │ [REQ_TEST]      │      │ 全部通过        │      │ 任务完成        │
     │ (修改完成)       │      │ [REQ_DOCS]      │      │ [TASK_DONE]     │
     └────────┬────────┘      └────────┬────────┘      └─────────────────┘
              │                        │
              │               ┌────────┴────────┐
              │               │                 │
              │               ▼                 ▼
              │      ┌─────────────────┐ ┌─────────────────┐
              │      │ 测试失败        │ │ 测试通过        │
              │      │ [REQ_DEV]       │ │ [REQ_DOCS]      │
              │      └────────┬────────┘ └────────┬────────┘
              │               │                   │
              └───────────────┘                   │
                              │                   │
                              │ (任意阶段阻塞)     │
                              ▼                   │
                     ┌─────────────────┐          │
                     │[BLOCK_NEED_MASTER]│        │
                     │  master-recovery │        │
                     └────────┬────────┘          │
                              │                   │
              ┌───────────────┼───────────────┐   │
              │               │               │   │
              ▼               ▼               ▼   │
     ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
     │missing_context│ │logic_unimp- │ │retry_exhausted│
     │ 嗅探重试     │ │lementable   │ │ 人工干预     │
     │             │ │ [TASK_DONE] │ │ [TASK_DONE] │
     └─────────────┘ └─────────────┘ └─────────────┘
                                            │
                                            ▼
                                   ┌─────────────────┐
                                   │  [TASK_DONE]    │
                                   │  任务完成       │
                                   └─────────────────┘
```

**状态机评价**：闭环完整，所有路径都有明确的终止状态。

### 2.3 通信媒介验证 ✅

| 文件 | 用途 | 写入者 | 读取者 | 覆写规则 |
|------|------|--------|--------|----------|
| `.trae/current_task.md` | 任务上下文 | Master Agent | 所有子 Agent | 每次任务分发时覆写 |
| `.trae/test_report.md` | 测试结果 | test-agent | Master Agent | 每次测试完成时覆写 |
| `.trae/blocked_reason.md` | 阻塞原因 | 任意 Agent | Master Agent | 每次阻塞时覆写 |

**覆写策略评价**：强制覆写策略有效防止上下文爆炸。

---

## 三、安全机制评估

### 3.1 熔断器规则 ✅

#### 重试计数机制

```yaml
# current_task.md 必须包含以下元数据
---
task_id: <唯一ID>
dev_retry_count: <当前重试次数，默认 0>
max_retries: <最大重试次数，默认 3>
---
```

#### 熔断触发条件

| 条件 | 动作 |
|------|------|
| `dev_retry_count < max_retries` | 允许路由，递增计数 |
| `dev_retry_count >= max_retries` | **禁止路由**，触发挂起，通知人类开发者 |

#### 熔断恢复流程

```
熔断触发
    │
    ▼
写入 blocked_reason.md (reason_type: retry_exhausted)
    │
    ▼
通知人类开发者
    │
    ├─► 继续任务：重置 dev_retry_count: 0，重新分发
    │
    └─► 放弃任务：清理媒介文件，结束任务
```

**熔断器评价**：设计完善，有效防止无限循环崩溃（Ping-Pong Effect）。

### 3.2 权限隔离 ✅

#### MCP 工具权限矩阵

| Agent | GitHub 读取 | GitHub 写入 | Memory 读取 | Memory 写入 | Playwright |
|-------|-------------|-------------|-------------|-------------|------------|
| Master | ✅ | ✅ | ✅ | ✅ | ❌ |
| dev-agent | ✅ | ❌ | ✅ | ❌ | ❌ |
| test-agent | ❌ | ❌ | ✅ | ❌ | ✅ (全量) |
| docs-agent | ✅ | ❌ | ✅ | ❌ | ❌ |

#### 文件编辑范围约束

| Agent | 允许编辑 | 禁止编辑 |
|-------|----------|----------|
| Master | 全部 | - |
| dev-agent | `src/` 等业务代码 | `tests/`、`*.md` |
| test-agent | `tests/` | `src/` 业务代码 |
| docs-agent | `*.md`、`docs/` | `src/`、`tests/` |

#### 禁止操作清单

| Agent | 禁止操作 |
|-------|----------|
| Master | 自行执行 E2E 测试、忽略 BLOCK 标签、熔断后继续路由、跳过微提交保护 |
| dev-agent | 使用 Playwright、写入 Memory、写入 GitHub、猜测 DOM 结构 |
| test-agent | 修改业务代码、猜测 DOM 结构、生成修复代码、提出修复建议、保存完整 HTML |
| docs-agent | 修改业务代码、修改测试代码、使用 Playwright |

**权限隔离评价**：最小权限原则执行到位，有效防止越权操作。

### 3.3 微提交保护 ✅

#### 触发时机

当收到 `[REQ_DEV]` 标签（测试失败需重写）时，必须在路由前执行保护操作。

#### 保护策略

| 策略 | 命令 | 适用场景 |
|------|------|----------|
| **git stash** | `git stash push -m "pre-fix state"` | 有未提交修改 |
| **WIP commit** | `git commit -m "WIP: pre-fix state before retry #N"` | 已暂存修改 |

#### 回滚能力

```bash
git stash pop  # 或
git reset --hard HEAD~1
```

**微提交保护评价**：确保代码覆灭风险可控。

---

## 四、工作流程一致性检查

### 4.1 七阶段验收流程 ✅

| 阶段 | 内容 | 执行者 | 命令 | 状态 |
|------|------|--------|------|------|
| 1 | 静态检查 | test-agent | `ruff check . && ruff format --check .` | ✅ |
| 2 | 单元测试 | test-agent | `pytest tests/unit/ -m "not real" -v` | ✅ |
| 3 | 集成测试 | test-agent | `pytest tests/integration/ -v` | ✅ |
| 4 | Dev 无头验收 | test-agent | `rscore --dev --headless` (降级: `python main.py`) | ✅ |
| 5 | User 无头验收 | test-agent | `rscore --user --headless` (降级: `python main.py`) | ✅ |
| 6 | 创建 PR | Master Agent | `gh pr create` | ✅ |
| 7 | 合并 PR | 人工确认 | 手动合并 | ✅ |

### 4.2 降级执行策略 ✅

```bash
# 步骤 1：尝试 rscore
rscore --dev --headless

# 步骤 2：如果 rscore 失败，降级到 python main.py
python main.py --dev --headless
```

| rscore 结果 | python main.py 结果 | 结论 |
|-------------|---------------------|------|
| ✅ 通过 | - | 正常 |
| ❌ 失败 | ✅ 通过 | rscore 入口问题 |
| ❌ 失败 | ❌ 失败 | 业务逻辑问题 |
| ❌ 不可用 | ✅ 通过 | rscore 未安装 |
| ❌ 不可用 | ❌ 失败 | 业务逻辑问题 |

**降级策略评价**：确保验收流程的鲁棒性。

### 4.3 AI 审查处理流程 ✅

#### AI 审查机器人

| 机器人 | 触发方式 | 可标记解决 | 解决状态检测 |
|--------|---------|-----------|-------------|
| Sourcery | `@sourcery-ai review` | ✅ 自动 | 检查 `body` 含 `✅ Addressed` |
| Copilot | 自动（PR 创建时） | ❌ | 无法判断，需人工处理 |
| Qodo | `/review` | ❌ | 无法判断，需人工处理 |

#### 审查问题分类

| 问题类型 | 来源 | 处理方式 |
|----------|------|----------|
| `bug_risk` | Sourcery | 必须修复 |
| `Bug` | Qodo | 必须修复 |
| `security` | 任意 | 必须修复 |
| `suggestion` | Copilot/Sourcery | 自主决断 |
| `performance` | 任意 | 自主决断 |

#### 合并限制

**重要限制**：项目要求合并前必须解决所有对话。

- **Sourcery**：自动检测 `✅ Addressed`
- **Copilot/Qodo**：无法通过 API 标记解决，需人工在 GitHub 网页点击"Resolve conversation"

**结论**：Agent 无法自主合并 PR，需人工确认。

---

## 五、文档一致性验证

### 5.1 文件引用一致性 ✅

| 引用位置 | 被引用文件 | 状态 |
|----------|------------|------|
| master.md | master-execution skill | ✅ 存在 |
| master.md | master-recovery skill | ✅ 存在 |
| dev-agent.md | dev-execution skill | ✅ 存在 |
| test-agent.md | test-execution skill | ✅ 存在 |
| docs-agent.md | docs-execution skill | ✅ 存在 |
| mcp-acceptance | pr-review skill | ✅ 存在 |
| pr-review | fetch-reviews skill | ✅ 存在 |

### 5.2 MCP 工具配置一致性 ✅

| Agent | GitHub | Memory | Playwright |
|-------|--------|--------|------------|
| Master | 读写 | 读写 | 无 |
| dev-agent | 只读 | 只读 | 无 |
| test-agent | 无 | 只读 | 全量 |
| docs-agent | 只读 | 只读 | 无 |

**评价**：配置与提示词描述一致。

### 5.3 仓库信息一致性 ✅

| 文件 | owner | repo | branch |
|------|-------|------|--------|
| master.md | Disaster-Terminator | RewardsCore | main |
| fetch-reviews | Disaster-Terminator | RewardsCore | - |

**评价**：仓库信息一致。

### 5.4 术语使用一致性 ✅

| 术语 | 定义位置 | 使用位置 | 状态 |
|------|----------|----------|------|
| 状态标签 | project_rules.md | 所有 Agent | ✅ 一致 |
| 媒介文件 | project_rules.md | 所有 Agent | ✅ 一致 |
| 熔断器 | master.md | master-execution | ✅ 一致 |
| 微提交保护 | master.md | master-execution | ✅ 一致 |
| 精简取证 | test-agent.md | test-execution | ✅ 一致 |
| 终止标签 | project_rules.md | 所有 Agent | ✅ 一致 |

---

## 六、框架演进历史分析

### 6.1 Specs 演进路径

```
enhance-multi-agent-framework
        │
        │  状态机重构 + 三层控制流架构
        │  新增通信媒介文件
        │  新增状态标签字典（4 个）
        ▼
multi-agent-safety-patch
        │
        │  熔断器机制
        │  强制覆写策略
        │  微提交保护
        │  精简取证规范
        ▼
framework-hardening-final
        │
        │  Master Watchdog 自我校验
        │  Memory MCP 结构化归档
        │  docs-agent 确定性触发算法
        │  Playwright 截图落盘规范
        ▼
state-machine-terminal
        │
        │  新增 [TASK_DONE] 终止标签
        │  Master Watchdog v2.0
        │  Memory 同步归档
        │  路由决策树固化
        ▼
    当前版本
```

### 6.2 已解决问题追踪 ✅

| 问题 | 解决方案 | 解决版本 |
|------|----------|----------|
| 状态机闭环缺失 | 新增 `[TASK_DONE]` 标签 | state-machine-terminal |
| 无限循环崩溃（Ping-Pong Effect） | 熔断器机制 | multi-agent-safety-patch |
| 上下文爆炸 | 强制覆写策略 | multi-agent-safety-patch |
| 代码覆灭风险 | 微提交保护 | multi-agent-safety-patch |
| Memory MCP 写入时机模糊 | pr-review 同步归档 | state-machine-terminal |
| docs-agent 触发条件模糊 | 确定性触发算法 | framework-hardening-final |
| 截图目录问题 | 物理执行序列 | state-machine-terminal |
| Master Watchdog 软约束 | v2.0 协议强化 | state-machine-terminal |

### 6.3 Checklist 完成状态 ✅

| Spec | Checklist 状态 |
|------|----------------|
| enhance-multi-agent-framework | ✅ 完成 |
| multi-agent-safety-patch | ✅ 完成 |
| framework-hardening-final | ✅ 完成 |
| state-machine-terminal | ✅ 完成 |

---

## 七、架构问题与解决方案记录

### 7.1 问题汇总

#### 一、架构问题

| # | 问题 | 影响 | 优先级 |
|---|------|------|--------|
| 1 | project_rules.md 对所有 agent 可见 | 子 agent 可能执行超出权限的操作（如写入 memory），导致记忆数据混乱 | 高 |
| 2 | Trae 上下文压缩导致仓库信息错乱 | owner/repo 名在压缩后变化 | 高 |
| 3 | GitHub MCP 无法正常获取 Qodo 评论 | 只能获取部分评论 | 中 |

#### 二、工作流问题

| # | 问题 | 影响 | 优先级 |
|---|------|------|--------|
| 4 | Master Agent 没有 Playwright MCP | 无法执行 E2E 测试 | ✅ 已解决 |
| 5 | 子 Agent 调用时机不明确 | 导致 Master Agent 直接执行测试 | ✅ 已解决 |
| 6 | 参数传递问题 | docs-agent 的 owner 参数不正确 | ✅ 已解决 |

#### 三、审查机器人问题

| # | 问题 | 影响 | 优先级 |
|---|------|------|--------|
| 7 | Qodo 评论格式特殊 | 评论包含 HTML 标签，MCP 工具返回数据被截断 | 中 |
| 8 | 三种审查机器人格式不同 | Sourcery/Copilot/Qodo 格式各异 | 低 |

### 7.2 解决方案实施记录

| 阶段 | 任务 | 状态 |
|------|------|------|
| 1 | 重命名 `.trae/prompts/` 为 `.trae/agents/` | ✅ 已完成 |
| 2 | 新建 `.trae/prompts/` 目录，创建 master.md | ✅ 已完成 |
| 3 | 精简 `project_rules.md`，添加身份判定 | ✅ 已完成 |
| 4 | 创建 `fetch-reviews` skill | ✅ 已完成 |
| 5 | 创建 `dispatch-agent` skill | ❌ 取消（简化流程） |
| 6 | 在 Memory MCP 中持久化仓库信息 | ✅ 已完成 |
| 7 | 完善 MCP 工具配置列表 | ✅ 已完成 |
| 8 | 精简规则文件，移除重复内容 | ✅ 已完成 |

### 7.3 经验教训

1. **不要假设 MCP 工具返回完整数据**：需要验证返回结果是否完整
2. **上下文压缩会丢失关键信息**：需要持久化锚点
3. **规则文件需要权限隔离**：避免子 agent 越权操作
4. **审查机器人格式各异**：需要统一的解析策略
5. **Skill 封装可降低上下文压力**：按需展开，不调用时不占用上下文
6. **身份判定需要默认值**：Solo coder 无内置提示词，需要通过"未指定身份则默认"机制获取身份

---

## 八、潜在问题与优化建议

### 8.1 已识别问题（已解决）

| 问题 | 状态 | 解决方案 |
|------|------|----------|
| 状态机缺乏终止状态 | ✅ 已解决 | 新增 `[TASK_DONE]` 标签 |
| Master Watchdog 软约束困境 | ✅ 已缓解 | v2.0 协议 + 多重提示 |
| Memory 归档触发时机不明确 | ✅ 已解决 | pr-review 同步绑定 |
| docs-agent 触发条件模糊 | ✅ 已解决 | 确定性触发算法 |
| 截图目录可能不存在 | ✅ 已解决 | 物理执行序列 |

### 8.2 潜在优化方向

| 优先级 | 问题 | 建议 | 状态 |
|--------|------|------|------|
| 低 | 软约束无法 100% 保证遵守 | 考虑在 Trae IDE 层面增加输出校验 | 持续观察 |
| 低 | 规则定义存在重复（project_rules.md + master.md） | 已采用指针引用架构缓解 | ✅ 已优化 |
| 低 | 新增 Agent/Skill 的扩展路径未文档化 | 建议增加扩展指南 | 待规划 |

### 8.3 扩展性评估

#### 新增 Agent 扩展路径

1. 在 `.trae/agents/` 目录创建 `<new-agent>.md`
2. 定义 Identity、Constraints、Execution、Routing
3. 配置 MCP 工具权限
4. 在 `project_rules.md` 中新增状态标签（如需要）
5. 创建对应的 Skill 文件

#### 新增 Skill 扩展路径

1. 在 `.trae/skills/<skill-name>/` 目录创建 `SKILL.md`
2. 定义触发条件、执行流程、输出格式
3. 在相关 Agent 配置中引用

**扩展性评价**：框架设计支持灵活扩展，但建议增加扩展指南文档。

---

## 九、总体评价与成熟度评估

### 9.1 优点总结

1. **架构清晰**：三层控制流设计，职责边界明确
2. **权限隔离**：最小权限原则，有效防止越权操作
3. **流程完整**：7 阶段验收覆盖全生命周期
4. **状态机闭环**：5 个标签含终止状态，转换完整
5. **降级策略**：rscore → python main.py 确保鲁棒性
6. **Skill 体系**：按需加载，降低上下文压力
7. **熔断器保护**：有效防止无限循环崩溃
8. **微提交保护**：确保代码覆灭风险可控

### 9.2 成熟度评估

| 维度 | 评分 | 说明 |
|------|------|------|
| 架构设计 | ⭐⭐⭐⭐⭐ | 三层控制流清晰，职责边界明确 |
| 流程完整性 | ⭐⭐⭐⭐⭐ | 7 阶段验收覆盖全流程 |
| 状态机闭环 | ⭐⭐⭐⭐⭐ | 5 个标签含终止状态，转换完整 |
| 安全机制 | ⭐⭐⭐⭐⭐ | 熔断器、权限隔离、微提交保护完善 |
| 文档一致性 | ⭐⭐⭐⭐⭐ | 文件引用、配置、术语一致 |
| 可扩展性 | ⭐⭐⭐⭐ | Skill 体系支持扩展，建议增加扩展指南 |

**总体评价**：框架设计成熟，已达生产级可用标准。

---

## 十、附录

### A. 状态标签快速参考

| 标签 | 输出者 | 接收者 | 场景 |
|------|--------|--------|------|
| `[REQ_DEV]` | Master, test-agent | dev-agent | 需要修改业务代码 |
| `[REQ_TEST]` | Master, dev-agent | test-agent | 需要执行测试验证 |
| `[REQ_DOCS]` | Master, test-agent | docs-agent | 需要同步文档 |
| `[BLOCK_NEED_MASTER]` | 任意子 Agent | Master Agent | 子任务受阻 |
| `[TASK_DONE]` | Master Agent | - | 任务完成，停止流转 |

### B. 阻塞原因类型快速参考

| reason_type | 含义 | 恢复策略 |
|-------------|------|----------|
| `missing_context` | 缺少 DOM 结构等上下文 | Master 调用 test-agent 嗅探，携新数据重试 |
| `logic_unimplementable` | 核心逻辑无法实现 | 停止流转，交出控制权给人类 |
| `mcp_failure` | MCP 调用连续失败 | Master 检查 MCP 配置，人工干预 |
| `retry_exhausted` | 重试次数耗尽（熔断触发） | 人工审查后决定是否继续 |

### C. AI 审查命令快速参考

| 机器人 | 命令 | 用途 |
|--------|------|------|
| Sourcery | `@sourcery-ai review` | 触发新审查 |
| Sourcery | `@sourcery-ai resolve` | 解决所有评论 |
| Sourcery | `@sourcery-ai dismiss` | 解除所有审查 |
| Qodo | `/review` | PR 审查 |
| Qodo | `/describe` | 生成 PR 描述 |
| Qodo | `/improve` | 代码改进建议 |

### D. 文件结构快速参考

```
.trae/
├── agents/
│   ├── dev-agent.md
│   ├── docs-agent.md
│   └── test-agent.md
├── documents/
│   ├── 多智能体协作框架全面分析报告.md
│   ├── 多智能体协作框架全面分析计划.md
│   ├── 多智能体协作框架审查报告.md
│   ├── 工程化闭环补丁实现反思.md
│   └── 规则分层优化计划.md
├── prompts/
│   └── master.md
├── rules/
│   └── project_rules.md
├── skills/
│   ├── dev-execution/SKILL.md
│   ├── docs-execution/SKILL.md
│   ├── fetch-reviews/SKILL.md
│   ├── master-execution/SKILL.md
│   ├── master-recovery/SKILL.md
│   ├── mcp-acceptance/SKILL.md
│   ├── pr-review/SKILL.md
│   └── test-execution/SKILL.md
├── specs/
│   ├── enhance-multi-agent-framework/
│   ├── framework-hardening-final/
│   ├── multi-agent-safety-patch/
│   └── state-machine-terminal/
├── blocked_reason.md
├── current_task.md
├── plan.md
└── test_report.md
```

---

*报告完成于 2026-02-23*
