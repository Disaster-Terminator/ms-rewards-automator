# 规则分层优化计划

## 问题背景

当前规则结构存在以下问题：

1. **项目规则膨胀**：Section 0.5（强制检查点）添加后，项目规则不再精简
2. **职责混淆**：通用操作规范与项目特定协议混在一起
3. **三层边界模糊**：全局 rule、项目 rule、skill 的职责划分不清晰

## 当前结构分析

### User Rules（全局规则）

```
来源：用户配置（IDE 设置）
内容：环境安全、文件操作规范
特点：描述措辞较软（"if appropriate"）
```

### Workspace Rules（项目规则）

```
来源：.trae/rules/project_rules.md
内容：
  - Section 0: Master 路由格式强制校验
  - Section 0.5: 强制检查点（刚添加）
  - Section 1-4: 多智能体协作协议
特点：描述措辞强硬（"must always follow"）
```

### Skills

```
来源：.trae/skills/*/SKILL.md
内容：具体执行流程（dev-execution, test-execution 等）
特点：按需调用，详细流程
```

## 问题诊断

### 1. Section 0.5 的位置问题

| 内容   | 本质     | 当前位置 | 问题            |
| ---- | ------ | ---- | ------------- |
| 环境安全 | 通用操作规范 | 项目规则 | 与项目特定协议混在一起   |
| 文件操作 | 通用操作规范 | 项目规则 | 与项目特定协议混在一起   |
| 检查清单 | 执行前确认  | 项目规则 | 更像是 Skill 的内容 |

### 2. 职责混淆

```
项目规则应该只包含：
  - 项目特定的约束（多智能体协议）
  - 项目特定的路由规则（状态标签）

通用操作规范应该属于：
  - 全局规则（但措辞需要加强）
```

### 3. Skill 与 Rule 的边界

```
Rule：强制约束，始终生效
  - "禁止自行安装依赖"
  - "必须输出路由标签"

Skill：详细流程，按需调用
  - "如何执行测试"
  - "如何修复代码"
  - "如何处理错误"
```

## 改进方案

### 方案：三层职责重新定义

```
┌─────────────────────────────────────────────────────────────┐
│  User Rules（全局规则）                                      │
│  - 来源：用户配置（不可修改）                                 │
│  - 内容：通用操作规范                                        │
│  - 特点：措辞较软，但 Agent 应主动遵守                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Project Rules（项目规则）                                   │
│  - 来源：.trae/rules/project_rules.md                       │
│  - 内容：项目特定约束                                        │
│    - 多智能体协作协议                                        │
│    - 路由标签规则                                            │
│    - 通信媒介规范                                            │
│  - 特点：精简、项目特定                                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Skills（执行流程）                                          │
│  - 来源：.trae/skills/*/SKILL.md                            │
│  - 内容：详细执行流程                                        │
│    - 操作步骤                                                │
│    - 错误处理                                                │
│    - 输出格式                                                │
│  - 特点：按需调用、详细                                      │
└─────────────────────────────────────────────────────────────┘
```

### 具体改动

#### 1. 精简项目规则

**移除**：Section 0.5（强制检查点）

**保留**：

* Section 0: Master 路由格式强制校验

* Section 1-4: 多智能体协作协议

**新增**：在 Section 0 中添加对 User Rules 的引用

```markdown
## 0. Master 路由格式强制校验 (Watchdog v2.0)

**前置约束**：执行任何操作前，必须遵守 User Rules 中的环境安全与文件操作规范。

作为 Master Agent，你在回复用户的最后一行，必须且只能输出路由标签。
...
```

#### 2. 在 Skill 中添加检查点

在 `dev-execution/SKILL.md` 和 `test-execution/SKILL.md` 的开头添加：

```markdown
## 前置检查（强制）

执行任何操作前，必须确认：

- [ ] 文件移动 → 使用 Move-Item 命令
- [ ] 环境操作 → 禁止自行安装，报告给用户
- [ ] 批量删除 → 使用 Remove-Item 命令
```

#### 3. 保持 User Rules 不变

User Rules 是用户配置，不应修改。但 Agent 应主动遵守。

## 改动后的结构

### project\_rules.md（精简版）

```markdown
## 0. Master 路由格式强制校验 (Watchdog v2.0)

**前置约束**：执行任何操作前，必须遵守 User Rules 中的环境安全与文件操作规范。

作为 Master Agent，你在回复用户的最后一行，必须且只能输出路由标签。

### 绝对约束
...

---

# 全局多智能体协作协议
...
```

### dev-execution/SKILL.md（添加前置检查）

```markdown
---
name: dev-execution
description: 开发执行详细流程。dev-agent 执行代码修改时调用。
---

# 开发执行详细流程

## 前置检查（强制）

执行任何操作前，必须确认：

- [ ] 文件移动 → 使用 Move-Item 命令
- [ ] 环境操作 → 禁止自行安装，报告给用户
- [ ] 批量删除 → 使用 Remove-Item 命令

## 触发条件
...
```

## 预期效果

1. **项目规则精简**：只保留项目特定的约束
2. **职责清晰**：三层各司其职
3. **检查点保留**：在 Skill 中保留前置检查
4. **引用关系**：项目规则引用 User Rules，Skill 引用项目规则

## 待确认

1. 是否同意移除 Section 0.5？
2. 是否同意在 Skill 中添加前置检查？
3. 是否有其他改进建议？

