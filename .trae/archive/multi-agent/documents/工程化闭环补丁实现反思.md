# 工程化闭环补丁实现反思

## 一、核心问题与思考

### 问题 1：Master Watchdog 协议的"软约束"困境

**现象**：
在 `project_rules.md` 中新增的 Master Watchdog 协议要求 Master Agent "执行内部正则自检"。但作为 LLM，这个约束本质上是"软约束"——Master Agent 可能会忽略或忘记执行。

**思考**：
- LLM 没有真正的"内部状态"可以执行正则自检
- 这个协议更像是一种"提示词工程"——通过重复强调来提高遵守概率
- 但无法 100% 保证 Master Agent 每次都输出正确格式

**可能的解决方案**：

| 方案 | 可行性 | 说明 |
|------|--------|------|
| 系统级拦截 | 高 | 在 Trae IDE 层面拦截 Master Agent 输出，执行正则校验 |
| 多重提示 | 中 | 在多个位置重复强调（project_rules.md + master.md） |
| 后处理修正 | 中 | 如果输出格式错误，自动提取正确标签 |

**我的选择**：采用"多重提示"方案，在 `project_rules.md` 和 `master.md` 中都定义该协议，提高遵守概率。

---

### 问题 2：Memory MCP 归档的触发时机不明确

**现象**：
定义了"PR 合并后触发归档"，但没有明确 Master Agent 如何检测 PR 状态变化。

**思考**：
- Master Agent 不是持续运行的守护进程
- 它只在用户请求时被唤醒
- PR 合并事件发生时，Master Agent 可能不在运行状态

**可能的解决方案**：

| 方案 | 可行性 | 说明 |
|------|--------|------|
| 在 pr-review skill 中触发 | 高 | PR 合并检查时顺带执行归档 |
| 用户手动触发 | 中 | 用户输入"归档"命令时执行 |
| 下次任务分发时检查 | 低 | 可能遗漏已合并的 PR |

**我的选择**：在 `pr-review` skill 中增加归档触发逻辑，当检测到 PR 已合并时执行归档。

---

### 问题 3：docs-agent 触发算法的执行方式未定义

**现象**：
定义了 `git diff HEAD~1` 检测命令，但没有说明 Master Agent 如何执行这些命令。

**思考**：
- Master Agent 有终端权限（RunCommand 工具）
- 但在路由决策时执行命令会增加延迟
- 是否应该在 skill 中明确"先执行检测，再路由"？

**可能的解决方案**：

| 方案 | 可行性 | 说明 |
|------|--------|------|
| 在 master-execution skill 中明确执行顺序 | 高 | 定义"检测 → 决策 → 路由"流程 |
| 使用 Git MCP 替代命令行 | 中 | 如果有 Git MCP，可以更优雅地执行 |
| 缓存检测结果 | 低 | 增加复杂度 |

**我的选择**：在 `master-execution` skill 中已定义执行流程，但可以更明确地说明"先执行检测命令，再决策"。

---

### 问题 4：截图落盘路径的目录创建问题

**现象**：
定义了截图保存路径 `logs/screenshots/{task_id}_crash.png`，但没有说明如果目录不存在怎么办。

**思考**：
- Playwright 的 `page.screenshot()` 不会自动创建目录
- 如果目录不存在，会抛出异常
- test-agent 需要在截图前检查并创建目录

**可能的解决方案**：

| 方案 | 可行性 | 说明 |
|------|--------|------|
| 在 test-execution skill 中增加目录检查 | 高 | 截图前执行 `os.makedirs()` |
| 使用项目初始化脚本 | 中 | 在项目启动时创建目录 |
| 使用绝对路径 | 低 | 不解决问题 |

**我的选择**：需要在 `test-execution` skill 中增加目录检查逻辑。

---

### 问题 5：协议定义的一致性维护

**现象**：
Master Watchdog 协议在 `project_rules.md` 和 `master.md` 中都有定义，存在重复。

**思考**：
- 重复定义增加了维护成本
- 如果两个文件的定义不一致，会造成混淆
- 应该遵循"单一真相源"原则

**可能的解决方案**：

| 方案 | 可行性 | 说明 |
|------|--------|------|
| 只在 project_rules.md 中定义 | 高 | 全局 Rule 作为唯一真相源 |
| 只在 master.md 中定义 | 中 | Agent 配置作为唯一真相源 |
| 两处都定义但明确引用关系 | 低 | 增加复杂度 |

**我的选择**：保留两处定义，但明确 `master.md` 引用 `project_rules.md` 中的定义。这样可以在 Agent 配置中提供上下文，同时保持全局 Rule 作为真相源。

---

### 问题 6：状态机缺少"任务完成"标签 🔴 关键缺陷

**现象**：
当前状态标签字典只定义了四个路由标签：

| 标签 | 用途 |
|------|------|
| `[REQ_DEV]` | 路由到 dev-agent |
| `[REQ_TEST]` | 路由到 test-agent |
| `[REQ_DOCS]` | 路由到 docs-agent |
| `[BLOCK_NEED_MASTER]` | 子任务受阻，移交 Master |

**问题**：没有"任务完成"标签！

**思考**：
- 当 Master Agent 完成任务（如提交 commit）后，无法输出一个表示"任务结束"的标签
- Master Watchdog 协议要求输出"必须且只能"匹配四个标签之一
- 这意味着 Master Agent 无法优雅地结束任务

**实际场景**：
```
用户：提交为 commit
Master Agent：执行 git add && git commit
Master Agent：??? → 无法输出"任务完成"
```

**可能的解决方案**：

| 方案 | 可行性 | 说明 |
|------|--------|------|
| 新增 `[TASK_DONE]` 标签 | 高 | 明确定义任务完成状态 |
| 允许无标签输出 | 中 | 放宽 Master Watchdog 约束 |
| 使用 `[REQ_DOCS]` 作为默认结束 | 低 | 语义不准确 |

**我的建议**：新增 `[TASK_DONE]` 标签，完善状态机闭环：

```
状态机完整闭环：
用户请求 → [REQ_DEV] → dev-agent → [REQ_TEST] → test-agent
    │                                          │
    │                                          ├─→ [REQ_DOCS] → docs-agent → [TASK_DONE]
    │                                          │
    │                                          └─→ [REQ_DEV] → dev-agent（修复循环）
    │
    └─→ [BLOCK_NEED_MASTER] → master-recovery → [TASK_DONE] 或继续
```

**修改建议**：
1. 在 `project_rules.md` 中新增 `[TASK_DONE]` 标签
2. 更新 Master Watchdog 协议，允许输出 `[TASK_DONE]`
3. 定义 `[TASK_DONE]` 的语义：任务完成，等待用户下一步指令

---

## 二、架构层面的思考

### 思考 1：三层控制流的边界模糊

**现象**：
在实现过程中，我发现某些协议应该放在哪一层并不总是清晰的。

**例子**：
- Master Watchdog 协议：放在第一层（全局 Rule）还是第二层（Agent 配置）？
- 最终选择放在第一层，因为它是"路由规则"

**思考**：
- 第一层应该只包含"路由规则"和"通信协议"
- 第二层应该包含"身份定义"和"约束边界"
- 第三层应该包含"执行细节"

**建议**：
明确三层的职责边界：
```
第一层（全局 Rule）：状态机定义 → 谁可以触发什么标签
第二层（Agent 配置）：API 契约 → 输入输出格式、权限边界
第三层（Skill 文件）：执行引擎 → 具体操作步骤
```

---

### 思考 2：确定性 vs 灵活性

**现象**：
工程化补丁的目标是增加"确定性"，但过度确定可能降低灵活性。

**例子**：
- docs-agent 触发算法：定义了严格的正则检测
- 但如果用户想强制触发文档更新呢？

**思考**：
- 应该保留"强制触发"的逃生舱口
- 例如：用户输入 `[REQ_DOCS]` 标签时，跳过检测直接路由

**建议**：
在确定性算法中保留人工干预入口：
```
检测流程：
1. 如果用户显式请求 → 直接路由
2. 否则 → 执行 Git Diff 检测
```

---

## 三、后续优化建议

### 短期（立即）

1. **修复截图目录问题**：在 `test-execution` skill 中增加目录检查
2. **明确 Memory 归档触发**：在 `pr-review` skill 中增加归档逻辑

### 中期（1 周）

1. **增加人工干预入口**：允许用户强制触发 docs-agent
2. **优化 Master Watchdog**：考虑在 Trae IDE 层面增加输出校验

### 长期（持续）

1. **监控协议遵守率**：记录 Master Agent 输出格式错误率
2. **迭代优化**：根据实际使用情况调整协议

---

## 四、总结

本次工程化闭环补丁实现了四个确定性协议，但在实现过程中暴露了一些深层次问题：

| 问题类型 | 具体问题 | 优先级 | 解决状态 |
|----------|----------|--------|----------|
| 🔴 状态机缺陷 | 缺少"任务完成"标签 | **关键** | 待新增 `[TASK_DONE]` |
| 🟡 软约束困境 | Master Watchdog 无法强制执行 | 高 | 多重提示缓解 |
| 🟡 触发时机 | Memory 归档如何触发 | 高 | 待在 pr-review 中实现 |
| 🟡 执行方式 | docs-agent 检测命令如何执行 | 中 | 已在 skill 中定义 |
| 🟢 路径问题 | 截图目录可能不存在 | 中 | 待修复 |
| 🟢 一致性 | 协议定义重复 | 低 | 明确引用关系 |

### 最关键的问题：状态机闭环缺失

当前状态机设计存在一个根本性缺陷：**没有终止状态**。

```
当前状态机：
用户请求 → [REQ_*] → 子 Agent → [REQ_*] → ... → ???
                                                    ↓
                                            无处可去！
```

这导致 Master Agent 在完成任务后无法优雅退出，必须"违反"自己定义的规则。

**建议立即修复**：新增 `[TASK_DONE]` 标签，完善状态机闭环。

这些问题需要在后续迭代中持续优化。
