# 项目规则

---

## 快速参考

| 用户说 | Agent 调用的 Skill |
|--------|-------------------|
| "处理评论"、"解决评论"、"PR 评论" | review-workflow |
| "验收"、"测试"、"开发完成" | acceptance-workflow |
| "获取评论"、"查看评论" | fetch-reviews |
| "解决某个评论" | resolve-review-comment |

---

## Skill 触发规则

**完整工作流触发**：

| 触发关键词 | 必须调用的 Skill | 说明 |
|------------|------------------|------|
| "验收"、"测试"、"开发完成"、"跑测试" | `acceptance-workflow` | 完整验收流程 |
| "处理评论"、"解决评论"、"PR 评论"、"审查评论" | `review-workflow` | 完整评论处理流程 |

**单独操作触发**：

| 触发关键词 | 必须调用的 Skill | 说明 |
|------------|------------------|------|
| "获取评论"、"查看评论" | `fetch-reviews` | 仅获取评论 |
| "解决某个评论" | `resolve-review-comment` | 仅解决评论 |

**强制调用检查**：
当用户请求包含上述关键词时，Agent **必须**首先调用对应 Skill。

---

## Skill 执行检查规则

**Agent 在执行 Skill 时必须遵循以下规则**：

1. **完整性检查**：Skill 中列出的所有阶段必须执行，不可跳过
2. **顺序检查**：必须按 Skill 定义的顺序执行
3. **失败处理**：某个阶段失败时，必须停止并报告，不可跳过继续
4. **完成确认**：所有阶段完成后，必须输出完整性检查结果

**违反以上规则的输出将被视为无效。**

---

## 工作流协调规则

**Agent 必须遵循以下工作流协调规则**：

1. **评论处理后必须验收**：处理 PR 评论并修改代码后，**必须**调用 `acceptance-workflow` 验收
2. **验收通过后必须解决评论**：验收通过后，**必须**调用 CLI 解决评论
3. **不可直接运行 pytest**：验收**必须**调用 `acceptance-workflow`，不可直接运行 pytest
4. **验收前检查评论状态**：如果有"必须修复"的评论未处理，**建议**先处理评论
   - 如果用户坚持验收，可以继续验收流程
   - 但必须在验收报告中注明"存在未处理的必须修复评论"

---

## pytest 执行规范

**优先使用并行测试**：Agent 必须先检查当前环境是否支持 pytest-xdist：

```bash
# 环境检查
python -c "import xdist" 2>$null; if ($LASTEXITCODE -eq 0) { echo "xdist_available" } else { echo "xdist_missing" }
```

**执行策略**：

| 环境状态 | 执行命令 |
|----------|----------|
| xdist 可用 | `pytest tests/unit/ -n auto -v` |
| xdist 不可用 | `pytest tests/unit/ -v`（降级为单线程） |

**注意**：若使用单线程模式，应在日志中记录"xdist 不可用，已降级为单线程执行"。

---

## 熔断机制

### 通用熔断

| 条件 | 动作 |
|------|------|
| 连续 3 次验证失败 | 停止执行，向用户报告 |
| 缺少必要上下文 | 停止执行，向用户请求信息 |
| 依赖缺失 | 停止执行，向用户报告 |

### 验收失败重试限制

**连续 2 次验收失败后，必须停止执行并等待人类干预。**

| 失败次数 | 动作 |
|----------|------|
| 首次失败 | 分析错误，修复代码，重试 |
| 连续第 2 次 | **触发熔断**：停止执行，输出错误汇总，等待人类干预 |

**原因**：避免陷入"修改代码-验收失败"的无限循环，防止 Token 消耗过高。

---

## 最佳实践

- 依赖缺失时，停止并报告给用户，不自行安装
- DOM 选择器从实际页面获取，不凭猜测
- 保存 HTML 时仅保留精简取证内容
- E2E 测试结束后及时关闭 Playwright 页面
