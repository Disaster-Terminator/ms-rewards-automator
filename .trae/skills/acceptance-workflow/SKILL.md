---
name: acceptance-workflow
description: |
  代码验收工作流（强制完整执行）。
  触发：用户说"验收"、"测试"、"开发完成"时。
  ⚠️ 必须完整执行所有阶段，不可跳过！
---

# 代码验收工作流

## ⚠️ 强制执行声明

此工作流的所有阶段必须按顺序完整执行，不可跳过任何阶段。
如果某个阶段失败，必须报告用户并停止，不可跳过继续。

---

## 前置检查（建议级别）

**注意**：此检查仅在验收开始时执行，目的是提醒用户。

```bash
python tools/manage_reviews.py list --status pending --format json
```

检查是否有"必须修复"的评论未处理：

| 结果 | 动作 |
|------|------|
| 有必须修复项 | **建议**用户先处理评论，但用户坚持可继续验收 |
| 无必须修复项 | 继续阶段 1 |

**如果没有活跃 PR**：跳过此检查，继续阶段 1

---

## 执行流程

### 阶段 1：静态检查

**执行前检查**：
- [ ] 代码已保存

**执行**：
```bash
ruff check . && ruff format --check .
```

**执行后检查**：
- [ ] 静态检查已通过

| 结果 | 动作 |
|------|------|
| 通过 | 输出 "✅ 阶段 1 完成"，继续阶段 2 |
| 失败 | 停止，报告错误 |

### 阶段 2：测试（单元 + 集成）

**⚠️ 优先使用并行测试，需先检查环境！**

**执行前检查**：
- [ ] 阶段 1 已完成

**环境检查**：
```bash
python -c "import xdist" 2>$null; if ($LASTEXITCODE -eq 0) { echo "xdist_available" } else { echo "xdist_missing" }
```

**执行**：

若 xdist 可用：
```bash
pytest tests/unit/ -n auto -v --tb=short --timeout=60 -m "not real"
pytest tests/integration/ -n auto -v --tb=short --timeout=120
```

若 xdist 不可用（降级）：
```bash
pytest tests/unit/ -v --tb=short --timeout=60 -m "not real"
pytest tests/integration/ -v --tb=short --timeout=120
```

**执行后检查**：
- [ ] 单元测试已通过
- [ ] 集成测试已通过

| 结果 | 动作 |
|------|------|
| 全部通过 | 输出 "✅ 阶段 2 完成"，继续阶段 3 |
| 有失败 | 停止，报告错误 |

### 阶段 3：审查评论检查（建议级别，如有 PR）

**⚠️ 此阶段为建议级别，不强制停止验收流程！**

**设计说明**：当 review-workflow 调用 acceptance-workflow 时，评论状态仍为 pending。为避免死锁，此阶段仅提示用户，不强制停止。

**执行前检查**：
- [ ] 阶段 2 已完成
- [ ] 当前有活跃 PR

**执行**：
```bash
python tools/manage_reviews.py list --status pending --format json
```

**检查逻辑**：

解析 `enriched_context.issue_type`，判断是否有必须修复项：

| 类型 | 来源 |
|------|------|
| Bug, Security, Rule violation, Reliability | Qodo |
| bug_risk, security | Sourcery |

**处理逻辑**：

| 分类 | 行为 |
|------|------|
| 有必须修复项 | **提示用户**，但继续阶段 4（由 review-workflow 在阶段 5 解决） |
| 仅有自主决断项 | 继续阶段 4 |

**执行后检查**：
- [ ] 评论状态已检查

| 结果 | 动作 |
|------|------|
| 无必须修复项 | 输出 "✅ 阶段 3 完成"，继续阶段 4 |
| 有必须修复项 | 输出 "⚠️ 阶段 3 完成（存在必须修复项）"，继续阶段 4 |

**注意**：如果没有活跃 PR，跳过此阶段。

### 阶段 4：E2E 验收

**⚠️ 此阶段不可跳过！**

**执行前检查**：
- [ ] 阶段 3 已完成（或跳过）

**执行**：
调用 e2e-acceptance Skill 执行。

**执行后检查**：
- [ ] E2E 验收已执行
- [ ] 验收结果已获取

| 结果 | 动作 |
|------|------|
| 全部通过 | 输出 "✅ 阶段 4 完成" |
| 有失败 | 使用 MCP Playwright 诊断，报告错误 |

---

## 完整性检查（强制）

在报告完成前，必须确认：
- [ ] 阶段 1：静态检查 - 已执行
- [ ] 阶段 2：测试 - 已执行（优先并行，可降级）
- [ ] 阶段 3：审查评论检查 - 已执行（如有 PR，建议级别）
- [ ] 阶段 4：E2E 验收 - 已执行

**如有未执行项，流程未完成！**

---

## 输出格式

### 成功

```
✅ 验收工作流完成
- ✅ 阶段 1：静态检查通过
- ✅ 阶段 2：测试通过（单元 X passed，集成 Y passed）
- ✅ 阶段 3：审查评论检查通过（如有 PR）
- ✅ 阶段 4：E2E 验收通过（Dev + User）
```

### 失败

```
❌ 验收工作流在阶段 N 失败
<错误详情>
```

### 存在必须修复项（继续验收）

```
⚠️ 验收工作流完成（存在未处理的必须修复评论）
- ✅ 阶段 1：静态检查通过
- ✅ 阶段 2：测试通过
- ⚠️ 阶段 3：存在 X 个必须修复项待处理
- ✅ 阶段 4：E2E 验收通过
- 建议：请在验收后处理上述必须修复项
```
