---
name: acceptance-workflow
description: |
  完整验收工作流（阶段1-5）。
  自动执行：静态检查 → 单元测试 → 集成测试 → 审查评论检查 → E2E无头验收。
  任何阶段失败都会停止并报告。
---

# 完整验收工作流

## 执行流程（强制顺序）

### 阶段 1：静态检查

```bash
ruff check . && ruff format --check .
```

| 结果 | 动作 |
|------|------|
| 通过 | 继续阶段 2 |
| 失败 | 停止，报告错误 |

### 阶段 2：单元测试（并行）

```bash
pytest tests/unit/ -n auto -v --tb=short --timeout=60 -m "not real"
```

| 结果 | 动作 |
|------|------|
| 全部通过 | 继续阶段 3 |
| 有失败 | 停止，报告错误 |

### 阶段 3：集成测试（并行）

```bash
pytest tests/integration/ -n auto -v --tb=short --timeout=120
```

| 结果 | 动作 |
|------|------|
| 全部通过 | 继续阶段 3.5 |
| 有失败 | 停止，报告错误 |

### 阶段 3.5：审查评论检查（如有PR）

**前置条件**：当前有活跃的PR

**检查流程**：

```
1. 调用 fetch-reviews skill 获取评论状态
2. 检查是否有"待处理"状态的必须修复项
3. 检查是否有"待判断"状态的建议性评论
```

| 结果 | 动作 |
|------|------|
| 无待处理项 | 继续阶段 4 |
| 有待处理项 | 停止，报告用户 |
| 有待判断项 | 提示用户确认后继续 |

**输出**：

```
✅ 审查评论检查通过
- 必须修复：0 待处理
- 建议性：X 已忽略，0 待判断
- 已解决：Y

或

❌ 审查评论检查失败
- 必须修复：X 待处理
- 请先处理上述问题
```

**注意**：如果没有活跃PR，跳过此阶段。

### 阶段 4-5：E2E 无头验收

调用 e2e-acceptance skill 执行。

---

## 输出格式

### 全部通过

```
✅ 验收工作流完成
- 静态检查：通过
- 单元测试：X passed（并行执行）
- 集成测试：Y passed（并行执行）
- 审查评论：通过（如有PR）
- Dev 无头验收：通过
- User 无头验收：通过
```

### 阶段 N 失败

```
❌ 验收工作流在阶段 N 失败

### 错误详情
<错误信息>
```

---

## 流程图

```
阶段1: 静态检查
       ↓
阶段2: 单元测试
       ↓
阶段3: 集成测试
       ↓
阶段3.5: 审查评论检查（如有PR）
       ↓
   ┌───┴───┐
   ↓       ↓
  通过    失败
   ↓       ↓
阶段4-5  停止报告
E2E验收
   ↓
  完成
```
