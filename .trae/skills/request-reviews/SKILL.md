---
name: request-reviews
description: |
  申请新的 AI 审查评论（编排层 Skill）。
  触发：用户说"申请新评论"、"重新审查"、"触发审查"时。
  注意：此 Skill 会先调用 fetch-reviews 处理待处理评论，再触发 AI 工具。
---

# 申请新审查工作流

## ⚠️ 执行声明

此 Skill 执行以下操作：

**阶段 1**：调用 fetch-reviews 处理待处理评论（不需要确认）

- 如果有待处理评论，先处理评论
- 如果无待处理评论，跳过此阶段

**阶段 2**：触发 AI 工具（需要用户确认）

- 发送 `@sourcery-ai review`
- 发送 `/agentic_review`

---

## 执行流程

### 阶段 1：处理待处理评论

**⚠️ 先处理待处理评论，再申请新审查！**

**执行**：

调用 fetch-reviews Skill 处理待处理评论。

**分支逻辑**：

- 有待处理评论 → 处理评论 → 输出报告 → 等待用户确认后继续阶段 2
- 无待处理评论 → 直接进入阶段 2

输出 "✅ 阶段 1 完成"

### 阶段 2：触发 AI 工具

**⚠️ 此阶段需要用户确认！**

**执行前检查**：

- [ ] 阶段 1 已完成（或跳过）
- [ ] 用户已确认触发 AI 工具

**获取 PR 编号**：

优先级顺序：

1. 从 git branch 推断（如 `pr-123` → PR #123）
2. 使用 GitHub CLI 查询：`gh pr view --json number`
3. 请求用户提供 PR 编号

**发送评论**：

使用 GitHub MCP 工具发送两条评论：

```
评论1：@sourcery-ai review
评论2：/agentic_review
```

**执行后检查**：

- [ ] 两条评论已发送
- [ ] Sourcery 已触发
- [ ] Qodo 已触发

输出 "✅ 阶段 2 完成"

### 阶段 3：异步通知

发送评论后，输出：

```
✅ 审查请求已发送
- Sourcery：已触发（@sourcery-ai review）
- Qodo：已触发（/agentic_review）

⏳ AI 工具通常需要 2-10 分钟响应
请稍后说"获取评论"查看新评论
```

输出 "✅ 阶段 3 完成"

---

## 完整性检查（强制）

在报告完成前，必须确认：

- [ ] 阶段 1：处理待处理评论 - 已执行（或跳过）
- [ ] 阶段 2：触发 AI 工具 - 已执行（两条评论）
- [ ] 阶段 3：异步通知 - 已执行

**如有未执行项，流程未完成！**

---

## 输出格式

```
✅ 新审查请求已发送
- Sourcery：已触发（@sourcery-ai review）
- Qodo：已触发（/agentic_review）

⏳ AI 工具通常需要 2-10 分钟响应
请稍后说"获取评论"查看新评论
```

---

## 降级策略

如果 GitHub MCP 工具失败：

1. 报告用户 MCP 工具异常
2. 提供手动操作指南：
   - 在 PR 页面手动评论 `@sourcery-ai review`
   - 在 PR 页面手动评论 `/agentic_review`
