# ⚠️ WARNING: This workflow runs on GitHub Actions cloud servers.
# Running automation on cloud servers may violate Microsoft Rewards Terms of Service
# and could result in account restrictions or bans.
# 
# Recommended: Run locally using `python main.py --schedule` instead.
# See README.md "安全建议" section for details.
#
# This workflow is provided for educational/research purposes only.
name: MS Rewards Daily Automation

on:
  schedule:
    - cron: '0 0 * * *'
    - cron: '0 6 * * *'
    - cron: '0 12 * * *'
  
  workflow_dispatch:
    inputs:
      mode:
        description: '执行模式'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - fast
          - slow
      desktop_only:
        description: '仅执行桌面搜索'
        required: false
        type: boolean
        default: false
      mobile_only:
        description: '仅执行移动搜索'
        required: false
        type: boolean
        default: false

jobs:
  run-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-playwright-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          if [ "${{ steps.playwright-cache.outputs.cache-hit }}" != "true" ]; then
            playwright install-deps chromium
          fi
      
      - name: Restore session state
        env:
          STORAGE_STATE: ${{ secrets.STORAGE_STATE }}
        run: |
          if [ -n "$STORAGE_STATE" ]; then
            echo "$STORAGE_STATE" > storage_state.json
            echo "✓ 会话状态已恢复"
          else
            echo "⚠️ 未找到会话状态，需要手动登录"
          fi
      
      - name: Create config file
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
        run: |
          cat > config.yaml << EOF
          search:
            desktop_count: 30
            mobile_count: 20
            wait_interval:
              min: 8
              max: 20
            search_terms_file: "tools/search_terms.txt"
          
          browser:
            headless: true
            slow_mo: 100
            timeout: 30000
          
          account:
            storage_state_path: "storage_state.json"
            login_url: "https://rewards.microsoft.com/"
          
          anti_detection:
            use_stealth: true
            random_viewport: true
            simulate_human_typing: true
            scroll_behavior:
              enabled: true
              min_scrolls: 2
              max_scrolls: 5
              scroll_delay_min: 500
              scroll_delay_max: 2000
          
          monitoring:
            enabled: true
            check_interval: 5
            check_points_before_task: true
            alert_on_no_increase: true
            max_no_increase_count: 3
          
          notification:
            enabled: true
            telegram:
              enabled: ${{ secrets.TELEGRAM_BOT_TOKEN != '' }}
              bot_token: "$TELEGRAM_BOT_TOKEN"
              chat_id: "$TELEGRAM_CHAT_ID"
            serverchan:
              enabled: ${{ secrets.SERVERCHAN_KEY != '' }}
              key: "$SERVERCHAN_KEY"
          
          scheduler:
            enabled: false
          
          error_handling:
            max_retries: 3
            retry_delay: 5
            exponential_backoff: true
          
          logging:
            level: "INFO"
            file: "logs/automator.log"
            console: true
          EOF
          echo "✓ 配置文件已创建"
      
      - name: Run automation
        run: |
          CMD="python main.py --headless"
          
          if [ "${{ github.event.inputs.mode }}" != "" ]; then
            CMD="$CMD --mode ${{ github.event.inputs.mode }}"
          fi
          
          if [ "${{ github.event.inputs.desktop_only }}" == "true" ]; then
            CMD="$CMD --desktop-only"
          fi
          
          if [ "${{ github.event.inputs.mobile_only }}" == "true" ]; then
            CMD="$CMD --mobile-only"
          fi
          
          echo "执行命令: $CMD"
          $CMD
      
      - name: Save session state
        if: always()
        run: |
          if [ -f storage_state.json ]; then
            echo "会话状态文件存在"
            echo "⚠️ 注意: 需要手动更新 STORAGE_STATE Secret"
          fi
      
      - name: Upload logs and reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-and-reports
          path: |
            logs/
            screenshots/
          retention-days: 7
      
      - name: Send failure notification
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            MESSAGE="❌ MS Rewards 自动化执行失败\n\n时间: $(date '+%Y-%m-%d %H:%M:%S')\n工作流: ${{ github.workflow }}\n运行ID: ${{ github.run_id }}"
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown"
          fi
